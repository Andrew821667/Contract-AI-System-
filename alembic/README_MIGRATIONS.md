# Database Migrations - Contract AI System v2.0

–≠—Ç–æ—Ç –∫–∞—Ç–∞–ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Contract AI System v2.0 —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π Multi-Model Routing –∏ RAG.

## üìã –°–ø–∏—Å–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π

### 001_create_idp_tables.py (–ë–∞–∑–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã)
**–°–æ–∑–¥–∞–Ω–æ:** 2026-01-08
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

**–¢–∞–±–ª–∏—Ü—ã:**
1. `contracts_core` - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (Hybrid Star Schema)
2. `contract_parties` - –°—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞
3. `contract_items` - –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è (–ø–æ–∑–∏—Ü–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞)
4. `payment_schedule` - –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π
5. `contract_rules` - –ü—Ä–∞–≤–∏–ª–∞ –∏ —Ñ–æ—Ä–º—É–ª—ã (Executable Logic)
6. `idp_extraction_log` - –õ–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ IDP
7. `idp_quality_issues` - –ü—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞ IDP

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- JSONB –ø–æ–ª—è –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏ (`attributes`, `raw_data`, `formula`)
- GIN –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è JSONB
- CHECK constraints –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- CASCADE —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

---

### 002_pgvector.py (–í–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)
**–°–æ–∑–¥–∞–Ω–æ:** 2026-01-09
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ù–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è v2.0

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è `vector` –¥–ª—è PostgreSQL
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ `embedding` –≤ `contracts_core` (ARRAY of Float)
- –°–æ–∑–¥–∞–Ω–∏–µ IVFFlat –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (cosine similarity)

**–ó–∞—á–µ–º:**
- –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤
- RAG (Retrieval-Augmented Generation)
- Recommendations Engine

---

### 003_negotiation_tables.py (Pre-Execution)
**–°–æ–∑–¥–∞–Ω–æ:** 2026-01-09
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ù–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è v2.0

**–¢–∞–±–ª–∏—Ü—ã:**
1. `negotiation_sessions` - –°–µ—Å—Å–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
   - –°—Ç–∞—Ç—É—Å—ã: `analyzing`, `awaiting_approval`, `approved`, `rejected`, `archived`
   - –ü–æ–ª—è: `risk_score`, `ai_recommendations` (JSONB)
   - –ú–µ—Ç—Ä–∏–∫–∏: `processed_by_model`, `processing_time_ms`, `cost_usd`

2. `disagreements` - –ü—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏–π
   - –ü–æ–ª—è: `their_clause`, `our_standard`, `suggested_wording`
   - –†–∏—Å–∫: `risk_level` (critical/high/medium/low)
   - **–ù–û–í–û–ï v2.1:** `ai_recommendation`, `precedents` (JSONB), `user_approved`

**–ó–∞—á–µ–º:**
- –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ (Pre-Execution Mode)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏–π
- –û–¥–æ–±—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Human-in-the-Loop)

---

### 004_system_tables.py (–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã)
**–°–æ–∑–¥–∞–Ω–æ:** 2026-01-09
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ù–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è v2.0

**–¢–∞–±–ª–∏—Ü—ã:**
1. `system_config` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
   - –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã: `full_load`, `sequential`, `manual`
   - –í–∫–ª—é—á–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏: `ocr`, `level1_extraction`, `llm_extraction`, `rag_filter`
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RAG: `top_k`, `similarity_threshold`
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Router: `default_model`, `complexity_threshold`

2. `user_approvals` - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–∏–π
   - –¢–∏–ø—ã: `negotiation`, `extraction`, `protocol`, `digitization`, `amendment`
   - –°—Ç–∞—Ç—É—Å—ã: `pending`, `approved`, `rejected`, `cancelled`
   - –ü–æ–ª–µ `data_preview` (JSONB) –¥–ª—è –ø—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã—Ö

**–ó–∞—á–µ–º:**
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞–º–∏ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã —á–µ—Ä–µ–∑ UI
- Human-in-the-Loop –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ê—É–¥–∏—Ç –≤—Å–µ—Ö –æ–¥–æ–±—Ä–µ–Ω–∏–π

**–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**
```json
{
  "system_mode": {"mode": "full_load"},
  "enabled_modules": {"modules": ["ocr", "level1_extraction", ...]},
  "rag_enabled": {"enabled": true, "top_k": 5},
  "router_config": {"default_model": "deepseek-v3", "complexity_threshold": 0.8}
}
```

---

### 005_knowledge_base.py (RAG)
**–°–æ–∑–¥–∞–Ω–æ:** 2026-01-09
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ù–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è v2.0

**–¢–∞–±–ª–∏—Ü–∞:**
1. `knowledge_base` - –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –¥–ª—è RAG
   - –¢–∏–ø—ã: `best_practice`, `regulation`, `precedent`, `template_clause`, `risk_pattern`, `negotiation_tactic`
   - –ü–æ–ª–µ `embedding` –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
   - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (JSONB): –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å, success_rate
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: `usage_count`, `last_used_at`

**–ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –¥–æ–≥–æ–≤–æ—Ä–∞—Ö –ø–æ—Å—Ç–∞–≤–∫–∏
- –ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–∞—è –ø–æ–¥—Å—É–¥–Ω–æ—Å—Ç—å (—Ä–∏—Å–∫)
- –ö–æ–º–ø—Ä–æ–º–∏—Å—Å –ø–æ —É—Å–ª–æ–≤–∏—è–º –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ —à—Ç—Ä–∞—Ñ–∞

**–ó–∞—á–µ–º:**
- RAG –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ü–æ–∏—Å–∫ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç–æ–≤

---

### 006_llm_metrics.py (–ú–µ—Ç—Ä–∏–∫–∏ LLM)
**–°–æ–∑–¥–∞–Ω–æ:** 2026-01-09
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ù–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è v2.0

**–¢–∞–±–ª–∏—Ü–∞:**
1. `llm_usage_metrics` - –ú–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LLM –º–æ–¥–µ–ª–µ–π
   - –ú–æ–¥–µ–ª–∏: `deepseek-v3`, `claude-4-5-sonnet`, `gpt-4o`, `gpt-4o-mini`
   - –ú–µ—Ç—Ä–∏–∫–∏: `tokens_input`, `tokens_output`, `cost_usd`, `processing_time_sec`
   - –û—Ü–µ–Ω–∫–∞: `complexity_score`, `confidence_score`
   - RAG: `rag_used`, `rag_docs_retrieved`

**–ó–∞—á–µ–º:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ –º–æ–¥–µ–ª—è–º
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
- Dashboard –º–µ—Ç—Ä–∏–∫ (Streamlit)
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Router (complexity_threshold)

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

### –í–∞—Ä–∏–∞–Ω—Ç 1: –°–∫—Ä–∏–ø—Ç
```bash
./scripts/apply_migrations.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Alembic
```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
alembic current

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π
alembic history

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head

# –û—Ç–∫–∞—Ç–∏—Ç—å –Ω–∞ –æ–¥–Ω—É –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞–∑–∞–¥
alembic downgrade -1

# –û—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic downgrade base
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –° —É–∫–∞–∑–∞–Ω–∏–µ–º DATABASE_URL
```bash
export DATABASE_URL="postgresql://user:password@localhost:5432/contract_ai"
alembic upgrade head
```

---

## üóÑÔ∏è –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ –ë–î (14 —Ç–∞–±–ª–∏—Ü)

### Post-Execution (–¶–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏—è)
1. ‚úÖ `contracts_core` - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
2. ‚úÖ `contract_parties` - –°—Ç–æ—Ä–æ–Ω—ã
3. ‚úÖ `contract_items` - –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
4. ‚úÖ `payment_schedule` - –ü–ª–∞—Ç–µ–∂–∏
5. ‚úÖ `contract_rules` - –ü—Ä–∞–≤–∏–ª–∞ (executable)

### Pre-Execution (–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã)
6. ‚úÖ `negotiation_sessions` - –°–µ—Å—Å–∏–∏ –∞–Ω–∞–ª–∏–∑–∞
7. ‚úÖ `disagreements` - –ü—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏–π

### IDP –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
8. ‚úÖ `idp_extraction_log` - –õ–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
9. ‚úÖ `idp_quality_issues` - –ü—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞

### –°–∏—Å—Ç–µ–º–∞
10. ‚úÖ `system_config` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
11. ‚úÖ `user_approvals` - –û–¥–æ–±—Ä–µ–Ω–∏—è
12. ‚úÖ `llm_usage_metrics` - –ú–µ—Ç—Ä–∏–∫–∏ LLM

### RAG
13. ‚úÖ `knowledge_base` - –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π

### –†–∞—Å—à–∏—Ä–µ–Ω–∏—è
14. ‚úÖ `vector` extension - pgvector –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–±–ª–∏—Ü:** 14
**–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–≥—Ä–∞—Ü–∏–π:** 6
**JSONB –∫–æ–ª–æ–Ω–æ–∫:** 15+
**–í–µ–∫—Ç–æ—Ä–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤:** 2 (contracts_core.embedding, knowledge_base.embedding)
**GIN –∏–Ω–¥–µ–∫—Å–æ–≤:** 8+

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **PostgreSQL 16+** –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è `gen_random_uuid()`
2. **pgvector extension** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –≤ PostgreSQL
3. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ** (001 ‚Üí 002 ‚Üí 003 ‚Üí ...)
4. **–û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π** –æ—á–∏—Å—Ç–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö (–±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã!)
5. **system_config** –∏–º–µ–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è - –Ω–µ —É–¥–∞–ª—è–π—Ç–µ –∏—Ö
6. **knowledge_base** –∏–º–µ–µ—Ç –ø—Ä–∏–º–µ—Ä—ã best practices - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–∫ —à–∞–±–ª–æ–Ω

---

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

–ï—Å–ª–∏ –≤—ã –∏–∑–º–µ–Ω–∏–ª–∏ –º–æ–¥–µ–ª–∏ SQLAlchemy, —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é:

```bash
alembic revision -m "Description of changes"
```

Alembic –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç —Ñ–∞–π–ª –≤ `alembic/versions/`. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `upgrade()` –∏ `downgrade()` —Ñ—É–Ω–∫—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é.

---

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2026-01-09
**–í–µ—Ä—Å–∏—è:** v2.1
