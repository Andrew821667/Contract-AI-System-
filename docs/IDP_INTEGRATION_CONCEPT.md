# üöÄ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ IDP (Intelligent Document Processing) –≤ Contract AI System

**–î–∞—Ç–∞:** 2026-01-08
**–°—Ç–∞—Ç—É—Å:** –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è
**–¶–µ–ª—å:** –ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –≤ "–í—ã—á–∏—Å–ª–∏–º—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã" (Computable Contracts)

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ](#–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ-—Ä–µ–∑—é–º–µ)
2. [–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã](#—Ç–µ–∫—É—â–µ–µ-—Å–æ—Å—Ç–æ—è–Ω–∏–µ-—Å–∏—Å—Ç–µ–º—ã)
3. [–¶–µ–ª–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ IDP](#—Ü–µ–ª–µ–≤–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-idp)
4. [–ì–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#–≥–∏–±—Ä–∏–¥–Ω–∞—è-—Å—Ö–µ–º–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
5. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ IDP](#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫-idp)
6. [–ü–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤](#–ø–∞–π–ø–ª–∞–π–Ω-–æ–±—Ä–∞–±–æ—Ç–∫–∏-–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
7. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π-—Å–∏—Å—Ç–µ–º–æ–π)
8. [API –∫–æ–Ω—Ç—Ä–∞–∫—Ç](#api-–∫–æ–Ω—Ç—Ä–∞–∫—Ç)
9. [–°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞—Ç—Ä–∞—Ç](#—Å—Ç—Ä–∞—Ç–µ–≥–∏—è-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏-–∑–∞—Ç—Ä–∞—Ç)
10. [–ü–ª–∞–Ω –ø–æ—ç—Ç–∞–ø–Ω–æ–≥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è](#–ø–ª–∞–Ω-–ø–æ—ç—Ç–∞–ø–Ω–æ–≥–æ-–≤–Ω–µ–¥—Ä–µ–Ω–∏—è)
11. [–ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞](#–º–µ—Ç—Ä–∏–∫–∏-—É—Å–ø–µ—Ö–∞)

---

## 1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ

### üéØ –ö–ª—é—á–µ–≤–∞—è —Ü–µ–ª—å

–ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç –∞—Ä—Ö–∏–≤–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∫ **—Ö—Ä–∞–Ω–µ–Ω–∏—é —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã—Ö –ø—Ä–∞–≤–∏–ª** –≤ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –ë–î. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç:

- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å** —Ä–∞—Å—á–µ—Ç —à—Ç—Ä–∞—Ñ–æ–≤, –ø–µ–Ω–µ–π, —Å—Ä–æ–∫–æ–≤
- **–°–æ–∑–¥–∞–≤–∞—Ç—å** dashboard —Å KPI –ø–æ –ø–æ—Ä—Ç—Ñ–µ–ª—é –¥–æ–≥–æ–≤–æ—Ä–æ–≤
- **–ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å** —Ä–∏—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è** —Å ERP/1C –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏

### üí° –ö–ª—é—á–µ–≤–∞—è –∏–Ω–Ω–æ–≤–∞—Ü–∏—è

**–ì–∏–±—Ä–∏–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –∂–µ—Å—Ç–∫–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏ (—Å—Ç–æ—Ä–æ–Ω—ã, —Å—É–º–º—ã, –¥–∞—Ç—ã) ‚Üí PostgreSQL —Ç–∞–±–ª–∏—Ü—ã, –≥–∏–±–∫–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã ‚Üí JSONB —Å GIN-–∏–Ω–¥–µ–∫—Å–∞–º–∏.

### üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ IDP | –ü–æ—Å–ª–µ IDP | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|--------|-----------|-----------|
| –¢–æ—á–Ω–æ—Å—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö | 60-70% (regex) | 90-95% (LLM + cascading) | +30-35% |
| –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ | 5-10 –º–∏–Ω (—Ä—É—á–Ω–∞—è) | 1-3 –º–∏–Ω (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è) | 5x —É—Å–∫–æ—Ä–µ–Ω–∏–µ |
| –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ | $5-10 (—á–µ–ª–æ–≤–µ–∫) | $0.10-0.50 (AI) | 10-50x —Å–Ω–∏–∂–µ–Ω–∏–µ |
| –ì–ª—É–±–∏–Ω–∞ –∞–Ω–∞–ª–∏–∑–∞ | –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–∞—è | –ü—É–Ω–∫—Ç-–∑–∞-–ø—É–Ω–∫—Ç–æ–º —Å –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç–∞–º–∏ | 10x –≥–ª—É–±–∂–µ |

---

## 2. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å

#### 2.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **Framework:** FastAPI 0.109+ (Python 3.9+)
- **–ë–î:** SQLAlchemy ORM (SQLite default, PostgreSQL-ready)
- **AI Stack:** LangChain, Multi-agent system
- **LLM Providers:** Claude, GPT-4, Perplexity, YandexGPT, DeepSeek, Qwen

#### 2.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
**DocumentParser** (`src/services/document_parser.py`):
- –§–æ—Ä–º–∞—Ç—ã: DOCX, PDF ‚Üí XML
- –ë–∞–∑–æ–≤–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ: parties, dates, amounts, INN
- OCR: Tesseract (–±–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å)
- –¢–∞–±–ª–∏—Ü—ã: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ DOCX

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã:**
- ‚ùå –ù–µ—Ç layout analysis (–Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É)
- ‚ùå –ù–∏–∑–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å OCR –¥–ª—è —Å–∫–∞–Ω–æ–≤ (Tesseract CPU)
- ‚ùå –ù–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–µ–π/–ø–µ—á–∞—Ç–µ–π
- ‚ùå –ù–µ—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- ‚ùå Regex-based extraction (–Ω–µ semantic)
- ‚ùå –ù–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è structured data –≤ –ë–î (—Ç–æ–ª—å–∫–æ XML –≤ JSONB)

#### 2.3 –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
**–ú–æ–¥–µ–ª—å `Contract`** (`src/models/database.py`):
```python
class Contract(Base):
    id = String(36, PK)
    file_path = Text  # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É
    document_type = String(50)  # contract, disagreement, tracked_changes
    contract_type = String(50)  # supply, service, lease
    status = String(50)  # pending, analyzing, completed
    meta_info = Text  # JSON (—Å–µ–π—á–∞—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è XML)
    ...
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ –Ω–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π XML –≤ `meta_info`. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã —Ç–∏–ø–∞:
```sql
-- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–µ–π—á–∞—Å
SELECT * FROM contracts
WHERE total_amount > 1000000
  AND currency = 'RUB'
  AND payment_terms LIKE '%prepayment%';
```

#### 2.4 AI-–∞–≥–µ–Ω—Ç—ã
**ContractAnalyzerAgent** (`src/agents/contract_analyzer_agent.py`):
- ‚úÖ Batch analysis (15 clauses/batch)
- ‚úÖ Risk identification
- ‚úÖ RAG integration (ChromaDB)
- ‚úÖ Counterparty checking (FNS API)
- ‚úÖ Cascading LLM (quick model ‚Üí deep model)

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:**
- –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≥–µ–Ω—Ç–æ–≤
- Batch processing –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
- –ö–∞—Å–∫–∞–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (Level 1: regex, Level 2: Llama-3, Level 3: GPT-4)

---

## 3. –¶–µ–ª–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ IDP

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FRONTEND (React/Next.js)                     ‚îÇ
‚îÇ          Document Upload ‚Üí Real-time Progress ‚Üí Results         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     FASTAPI BACKEND                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  API Layer (src/api/contracts/routes.py)                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  POST /api/v1/contracts/upload                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  POST /api/v1/idp/process                                ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                        ‚îÇ                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  üÜï IDP Orchestrator (src/services/idp_orchestrator.py)  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Document classification                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Router to appropriate pipeline                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Result normalization                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Error handling & fallback                             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ     ‚îÇ        ‚îÇ          ‚îÇ             ‚îÇ                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇXML  ‚îÇ ‚îÇ AI  ‚îÇ ‚îÇ Hybrid    ‚îÇ ‚îÇ Local Processing       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇDet  ‚îÇ ‚îÇCloud‚îÇ ‚îÇ (XML+AI)  ‚îÇ ‚îÇ (CPU-based models)     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     ‚îÇ ‚îÇ IDP ‚îÇ ‚îÇ           ‚îÇ ‚îÇ                         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ     ‚îÇ       ‚îÇ          ‚îÇ             ‚îÇ                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  üÜï IDP Data Processor (src/services/idp_processor.py)   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Layout analysis (LayoutLMv3 ONNX)                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Entity extraction (BERT NER + LLM cascading)          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Table extraction (PaddleOCR + structure analysis)     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Signature detection                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Field validation (Pydantic)                           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                      ‚îÇ                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  üÜï Hybrid Star Schema Mapper                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  (src/services/schema_mapper.py)                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Standard fields ‚Üí DB columns                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Dynamic fields ‚Üí JSONB attributes                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Rules ‚Üí contract_rules table                          ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                      ‚îÇ                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  PostgreSQL Database                                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  üìä contracts_core (fact table)                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  üìä contract_parties, contract_items, payment_schedule   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  üìä contract_rules (executable logic)                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  üìä idp_extraction_log (audit trail)                     ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üîß –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 3.1 IDP Orchestrator
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/services/idp_orchestrator.py`

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ (XML vs PDF vs —Å–∫–∞–Ω)
- –í—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á (Celery/Redis)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –æ—à–∏–±–æ–∫

**–õ–æ–≥–∏–∫–∞ —Ä–æ—É—Ç–∏–Ω–≥–∞:**
```python
if document.is_xml:
    pipeline = DeterministicXMLParser()
elif document.is_searchable_pdf:
    pipeline = HybridPipeline(ocr=False, llm_level=2)
elif document.is_scanned_pdf:
    pipeline = FullAIPipeline(ocr=True, llm_level=3)
```

#### 3.2 IDP Data Processor
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/services/idp_processor.py`

**–≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
1. **Segmentation** (LayoutLMv3): Header, Preamble, Terms, Payment_Table, Signatures
2. **Cascading Extraction:**
   - Level 1 (CPU, –±–µ—Å–ø–ª–∞—Ç–Ω–æ): Regex + SpaCy NER ‚Üí INN, –¥–∞—Ç—ã, —Å—É–º–º—ã
   - Level 2 (API, –¥–µ—à–µ–≤–æ): Llama-3-8B ‚Üí —Ç–∞–±–ª–∏—Ü—ã, —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã
   - Level 3 (API, –¥–æ—Ä–æ–≥–æ): GPT-4o ‚Üí —à—Ç—Ä–∞—Ñ—ã, —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä, —Å–ª–æ–∂–Ω—ã–µ –ø—É–Ω–∫—Ç—ã
3. **Normalization:** –°–ª–∏—è–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ Intermediate JSON
4. **Validation:** Pydantic models

#### 3.3 Schema Mapper
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/services/schema_mapper.py`

**–õ–æ–≥–∏–∫–∞ –º–∞–ø–ø–∏–Ω–≥–∞:**
```python
def map_to_db(intermediate_json: dict) -> DatabaseRecord:
    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è ‚Üí –∫–æ–ª–æ–Ω–∫–∏
    contract_core = {
        'doc_number': extract_field('contract_number'),
        'signed_date': extract_field('signature_date'),
        'total_amount': extract_field('total_amount'),
        'currency': extract_field('currency', default='RUB')
    }

    # –ì–∏–±–∫–∏–µ –ø–æ–ª—è ‚Üí JSONB attributes
    contract_core['attributes'] = {
        'delivery_type': extract_field('delivery_type'),
        'project_manager': extract_field('project_manager'),
        'special_conditions': extract_field('special_conditions'),
        # ... –ª—é–±—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    }

    # –ü—Ä–∞–≤–∏–ª–∞ ‚Üí contract_rules
    rules = extract_rules(intermediate_json)

    return contract_core, rules
```

---

## 4. –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### üìä Hybrid Star Schema (PostgreSQL 16+)

#### 4.1 –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (Fact Table)

```sql
CREATE TABLE contracts_core (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è (–∂–µ—Å—Ç–∫–∞—è —Å—Ö–µ–º–∞)
    doc_number VARCHAR(100) NOT NULL,
    signed_date DATE,
    status VARCHAR(20) CHECK (status IN ('draft', 'active', 'closed', 'dispute')),
    total_amount NUMERIC(15, 2),
    currency CHAR(3) DEFAULT 'RUB',

    -- üîë –ö–õ–Æ–ß–ï–í–ê–Ø –ò–ù–ù–û–í–ê–¶–ò–Ø: –ì–∏–±–∫–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã
    attributes JSONB,  -- GIN index –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

    -- –ü–æ–ª–Ω—ã–π "—Å—ã—Ä–æ–π" —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)
    raw_data JSONB,

    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    processed_by VARCHAR(50),  -- 'xml_parser', 'ai_pipeline', 'manual'

    -- Foreign keys
    source_file_id UUID REFERENCES contracts(id),

    -- –ò–Ω–¥–µ–∫—Å—ã
    CONSTRAINT check_amount CHECK (total_amount >= 0)
);

-- GIN –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ JSONB
CREATE INDEX idx_contracts_attributes ON contracts_core USING GIN (attributes);
CREATE INDEX idx_contracts_doc_number ON contracts_core (doc_number);
CREATE INDEX idx_contracts_signed_date ON contracts_core (signed_date);
CREATE INDEX idx_contracts_status ON contracts_core (status);
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ —Å JSONB:**
```sql
-- –ù–∞–π—Ç–∏ –≤—Å–µ –¥–æ–≥–æ–≤–æ—Ä—ã —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –∞–≤–∏–∞—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º
SELECT * FROM contracts_core
WHERE attributes @> '{"delivery_type": "air"}';

-- –ù–∞–π—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä—ã, –≥–¥–µ project_manager = 'Ivanov'
SELECT * FROM contracts_core
WHERE attributes->>'project_manager' = 'Ivanov';

-- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
SELECT * FROM contracts_core
WHERE total_amount > 1000000
  AND currency = 'RUB'
  AND attributes @> '{"priority": "high"}';
```

#### 4.2 –ò–∑–º–µ—Ä–µ–Ω–∏—è (Dimension Tables)

```sql
-- ============================================================
-- –°—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞
-- ============================================================
CREATE TABLE contract_parties (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    contract_id UUID NOT NULL REFERENCES contracts_core(id) ON DELETE CASCADE,

    -- –†–æ–ª—å —Å—Ç–æ—Ä–æ–Ω—ã
    role VARCHAR(50) CHECK (role IN ('buyer', 'seller', 'guarantor', 'agent')),

    -- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    entity_id UUID,  -- –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å ERP)
    name VARCHAR(500) NOT NULL,
    tax_id VARCHAR(20),  -- –ò–ù–ù/VAT
    registration_number VARCHAR(50),  -- –û–ì–†–ù

    -- –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    legal_address TEXT,
    actual_address TEXT,
    contact_person VARCHAR(200),
    email VARCHAR(100),
    phone VARCHAR(50),

    -- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
    bank_details JSONB,  -- {account, bank_name, bik, correspondent_account}

    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at TIMESTAMP DEFAULT NOW(),

    -- –ò–Ω–¥–µ–∫—Å—ã
    CONSTRAINT unique_contract_party UNIQUE (contract_id, role, tax_id)
);

CREATE INDEX idx_parties_contract ON contract_parties (contract_id);
CREATE INDEX idx_parties_tax_id ON contract_parties (tax_id);
CREATE INDEX idx_parties_entity ON contract_parties (entity_id);


-- ============================================================
-- –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è (–ø–æ–∑–∏—Ü–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞)
-- ============================================================
CREATE TABLE contract_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    contract_id UUID NOT NULL REFERENCES contracts_core(id) ON DELETE CASCADE,

    -- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏
    line_number INTEGER NOT NULL,
    sku_code VARCHAR(100),  -- –ê—Ä—Ç–∏–∫—É–ª –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ —Å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–æ–π

    -- –û–ø–∏—Å–∞–Ω–∏–µ
    name TEXT NOT NULL,
    description TEXT,

    -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü—ã
    quantity NUMERIC(15, 3) NOT NULL,
    unit VARCHAR(20),  -- —à—Ç, –∫–≥, –º, —á–∞—Å, etc.

    -- –§–∏–Ω–∞–Ω—Å—ã
    price_unit NUMERIC(15, 2) NOT NULL,
    total_line NUMERIC(15, 2) NOT NULL,
    vat_rate NUMERIC(5, 2),  -- 20%, 10%, 0%
    vat_amount NUMERIC(15, 2),

    -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã (–≥–∏–±–∫–∏–µ)
    attributes JSONB,  -- {color, size, model, delivery_date, etc.}

    created_at TIMESTAMP DEFAULT NOW(),

    -- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
    CONSTRAINT check_quantity CHECK (quantity > 0),
    CONSTRAINT check_price CHECK (price_unit >= 0),
    CONSTRAINT unique_contract_line UNIQUE (contract_id, line_number)
);

CREATE INDEX idx_items_contract ON contract_items (contract_id);
CREATE INDEX idx_items_sku ON contract_items (sku_code);
CREATE INDEX idx_items_attributes ON contract_items USING GIN (attributes);


-- ============================================================
-- –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π
-- ============================================================
CREATE TABLE payment_schedule (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    contract_id UUID NOT NULL REFERENCES contracts_core(id) ON DELETE CASCADE,

    -- –¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞
    payment_type VARCHAR(50) CHECK (payment_type IN (
        'prepayment', 'postpayment', 'milestone', 'recurring', 'on_delivery'
    )),

    -- –°—É–º–º–∞
    amount NUMERIC(15, 2) NOT NULL,
    percentage NUMERIC(5, 2),  -- % –æ—Ç –æ–±—â–µ–π —Å—É–º–º—ã

    -- –°—Ä–æ–∫–∏
    due_date DATE,  -- –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –¥–∞—Ç–∞ (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–∞)
    due_condition TEXT,  -- –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –¥–∞—Ç–∞: "5 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –∞–∫—Ç–∞"
    days_offset INTEGER,  -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –æ—Ç —Å–æ–±—ã—Ç–∏—è
    trigger_event VARCHAR(100),  -- –¢—Ä–∏–≥–≥–µ—Ä: 'contract_signing', 'delivery', 'act_signing'

    -- –°—Ç–∞—Ç—É—Å
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'paid', 'overdue', 'cancelled')),
    paid_date DATE,
    paid_amount NUMERIC(15, 2),

    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at TIMESTAMP DEFAULT NOW(),

    CONSTRAINT check_payment_amount CHECK (amount >= 0)
);

CREATE INDEX idx_payment_contract ON payment_schedule (contract_id);
CREATE INDEX idx_payment_status ON payment_schedule (status);
CREATE INDEX idx_payment_due_date ON payment_schedule (due_date);


-- ============================================================
-- üî• –î–í–ò–ñ–û–ö –ü–†–ê–í–ò–õ (Executable Logic)
-- ============================================================
CREATE TABLE contract_rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    contract_id UUID NOT NULL REFERENCES contracts_core(id) ON DELETE CASCADE,

    -- –¢–∏–ø –ø—Ä–∞–≤–∏–ª–∞
    section_type VARCHAR(50) CHECK (section_type IN (
        'liability',        -- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
        'penalty',          -- –®—Ç—Ä–∞—Ñ—ã
        'termination',      -- –†–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ
        'sla',              -- SLA/–≥–∞—Ä–∞–Ω—Ç–∏–∏
        'force_majeure',    -- –§–æ—Ä—Å-–º–∞–∂–æ—Ä
        'dispute',          -- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–ø–æ—Ä–æ–≤
        'confidentiality'   -- –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å
    )),

    -- –ü—Ä–∞–≤–∏–ª–æ (–∏—Å–ø–æ–ª–Ω—è–µ–º–∞—è –ª–æ–≥–∏–∫–∞)
    rule_name VARCHAR(200) NOT NULL,
    trigger_condition TEXT,  -- "delay_days > 0", "quality_defects > 0"

    -- –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ (JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
    formula JSONB NOT NULL,
    /* –ü—Ä–∏–º–µ—Ä—ã formula:
    {
        "type": "penalty",
        "rate": 0.001,          // 0.1% –≤ –¥–µ–Ω—å
        "base": "outstanding_balance",  // –û—Ç —á–µ–≥–æ —Å—á–∏—Ç–∞–µ–º
        "period": "daily",      // daily, weekly, monthly
        "cap": 0.10,            // –ú–∞–∫—Å–∏–º—É–º 10%
        "min_amount": 1000      // –ú–∏–Ω–∏–º—É–º 1000 —Ä—É–±
    }

    {
        "type": "termination",
        "trigger": "delay_days > 30",
        "notice_period_days": 10,
        "compensation": "return_prepayment"
    }
    */

    -- –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ (–¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è)
    original_text TEXT NOT NULL,
    clause_location VARCHAR(200),  -- XPath –∏–ª–∏ –Ω–æ–º–µ—Ä –ø—É–Ω–∫—Ç–∞

    -- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    priority INTEGER DEFAULT 0,  -- –î–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∞–≤–∏–ª
    is_active BOOLEAN DEFAULT TRUE,

    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at TIMESTAMP DEFAULT NOW(),
    extracted_by VARCHAR(50),  -- 'llm_gpt4', 'manual', 'xml_parser'
    confidence_score NUMERIC(3, 2),  -- 0.00-1.00

    CONSTRAINT check_confidence CHECK (confidence_score BETWEEN 0 AND 1)
);

CREATE INDEX idx_rules_contract ON contract_rules (contract_id);
CREATE INDEX idx_rules_section_type ON contract_rules (section_type);
CREATE INDEX idx_rules_active ON contract_rules (is_active);
CREATE INDEX idx_rules_formula ON contract_rules USING GIN (formula);
```

#### 4.3 –ê—É–¥–∏—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ IDP

```sql
-- ============================================================
-- –õ–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ IDP (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –∞—É–¥–∏—Ç–∞)
-- ============================================================
CREATE TABLE idp_extraction_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    contract_id UUID REFERENCES contracts_core(id) ON DELETE SET NULL,

    -- –≠—Ç–∞–ø –æ–±—Ä–∞–±–æ—Ç–∫–∏
    stage VARCHAR(50) CHECK (stage IN (
        'classification', 'ocr', 'layout_analysis',
        'entity_extraction', 'table_extraction',
        'rule_extraction', 'validation'
    )),

    -- –°—Ç–∞—Ç—É—Å
    status VARCHAR(20) CHECK (status IN ('success', 'partial', 'failed')),

    -- –î–µ—Ç–∞–ª–∏
    input_data JSONB,   -- –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–∞–ø–∞
    output_data JSONB,  -- –†–µ–∑—É–ª—å—Ç–∞—Ç —ç—Ç–∞–ø–∞
    error_message TEXT,

    -- –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    duration_ms INTEGER,  -- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –º—Å
    tokens_used INTEGER,  -- –¢–æ–∫–µ–Ω—ã LLM (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
    cost_usd NUMERIC(10, 4),  -- –°—Ç–æ–∏–º–æ—Å—Ç—å —ç—Ç–∞–ø–∞

    -- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    processor_type VARCHAR(50),  -- 'layoutlm', 'gpt4o', 'llama3', 'regex'
    model_version VARCHAR(50),

    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at TIMESTAMP DEFAULT NOW(),

    -- –ò–Ω–¥–µ–∫—Å—ã
    CREATE INDEX idx_idp_log_contract ON idp_extraction_log (contract_id);
    CREATE INDEX idx_idp_log_stage ON idp_extraction_log (stage);
    CREATE INDEX idx_idp_log_status ON idp_extraction_log (status);
);


-- ============================================================
-- –¢–∞–±–ª–∏—Ü–∞ –æ—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π IDP
-- ============================================================
CREATE TABLE idp_quality_issues (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    contract_id UUID NOT NULL REFERENCES contracts_core(id) ON DELETE CASCADE,
    extraction_log_id UUID REFERENCES idp_extraction_log(id),

    -- –¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã
    issue_type VARCHAR(50) CHECK (issue_type IN (
        'low_ocr_confidence',    -- –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å OCR
        'missing_field',          -- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
        'ambiguous_value',        -- –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        'validation_error',       -- –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        'conflicting_data'        -- –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    )),

    -- –£—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
    severity VARCHAR(20) CHECK (severity IN ('critical', 'warning', 'info')),

    -- –û–ø–∏—Å–∞–Ω–∏–µ
    field_name VARCHAR(100),
    expected_value TEXT,
    actual_value TEXT,
    description TEXT,

    -- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    suggested_action VARCHAR(200),
    requires_manual_review BOOLEAN DEFAULT FALSE,

    -- –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
    status VARCHAR(20) DEFAULT 'open' CHECK (status IN ('open', 'resolved', 'ignored')),
    resolved_at TIMESTAMP,
    resolved_by UUID REFERENCES users(id),

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_quality_contract ON idp_quality_issues (contract_id);
CREATE INDEX idx_quality_severity ON idp_quality_issues (severity);
CREATE INDEX idx_quality_status ON idp_quality_issues (status);
```

### üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Hybrid Star Schema

| –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|--------------|----------|--------|
| **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** | –ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å SQL-–∞–≥—Ä–µ–≥–∞—Ü–∏–∏ | `SELECT SUM(total_amount) FROM contracts_core WHERE signed_date > '2024-01-01'` |
| **–ì–∏–±–∫–æ—Å—Ç—å** | –ù–æ–≤—ã–µ –ø–æ–ª—è –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î | –î–æ–±–∞–≤–∏–ª–∏ `{"delivery_by_train": true}` ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ `attributes` |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | GIN –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è JSONB | –ü–æ–∏—Å–∫ –ø–æ 1–ú –¥–æ–≥–æ–≤–æ—Ä–æ–≤ < 50–º—Å |
| **–ò—Å–ø–æ–ª–Ω—è–µ–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞** | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —à—Ç—Ä–∞—Ñ–æ–≤ | `formula: {"rate": 0.001, "period": "daily"}` ‚Üí Python function |
| **ERP –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** | –ü—Ä—è–º–æ–π SQL-—ç–∫—Å–ø–æ—Ä—Ç –≤ 1C/SAP | `INSERT INTO 1c_contracts SELECT * FROM contracts_core` |

---

## 5. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ IDP

### üß† AI & ML Stack (Cascading Pipeline)

#### 5.1 Layout Analysis
**–ú–æ–¥–µ–ª—å:** LayoutLMv3 (Microsoft)
**–ó–∞–¥–∞—á–∞:** –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏
**Deployment:** ONNX Runtime (CPU inference)
**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 3-5 —Å–µ–∫/—Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ CPU

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
pip install onnxruntime transformers
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```python
# src/services/layout_analyzer.py
from transformers import LayoutLMv3Processor, LayoutLMv3ForTokenClassification
import onnxruntime

class LayoutAnalyzer:
    def __init__(self):
        self.session = onnxruntime.InferenceSession(
            "models/layoutlmv3-base-finetuned-contracts.onnx"
        )

    def segment_document(self, image_path: str) -> List[DocumentBlock]:
        """
        –†–∞–∑–±–∏–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ –±–ª–æ–∫–∏:
        - Header (–∑–∞–≥–æ–ª–æ–≤–æ–∫)
        - Preamble (–ø—Ä–µ–∞–º–±—É–ª–∞)
        - Terms (—É—Å–ª–æ–≤–∏—è)
        - Payment_Table (—Ç–∞–±–ª–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã)
        - Signatures (–ø–æ–¥–ø–∏—Å–∏)
        """
        # Inference —á–µ—Ä–µ–∑ ONNX (CPU, 3-5 —Å–µ–∫/—Å—Ç—Ä–∞–Ω–∏—Ü–∞)
        blocks = self.session.run(...)

        return [
            DocumentBlock(type='header', bbox=(x1,y1,x2,y2), text='...'),
            DocumentBlock(type='terms', bbox=(x1,y1,x2,y2), text='...'),
            ...
        ]
```

#### 5.2 OCR Engine
**–ü–µ—Ä–≤–∏—á–Ω—ã–π –≤—ã–±–æ—Ä:** PaddleOCR (–æ–ø—Ç–∏–º–∞–ª–µ–Ω –¥–ª—è —Ç–∞–±–ª–∏—Ü, –ª—É—á—à–µ —á–µ–º Tesseract)
**Fallback:** Tesseract (—É–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω)
**–û–±–ª–∞—á–Ω—ã–π fallback:** Azure AI Vision OCR (–¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤)

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ PaddleOCR:**
```bash
pip install paddlepaddle paddleocr
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```python
# src/services/ocr_service.py (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ)
from paddleocr import PaddleOCR

class EnhancedOCRService:
    def __init__(self):
        # PaddleOCR (primary)
        self.paddle_ocr = PaddleOCR(
            use_angle_cls=True,
            lang='ru',
            use_gpu=False  # CPU mode –¥–ª—è MVP
        )

        # Tesseract (fallback)
        self.tesseract = pytesseract

    def extract_text(self, image_path: str, prefer_structure: bool = False) -> OCRResult:
        """
        prefer_structure=True -> –∏—Å–ø–æ–ª—å–∑—É–µ–º PaddleOCR (–ª—É—á—à–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü)
        prefer_structure=False -> Tesseract (–±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞)
        """
        if prefer_structure:
            result = self.paddle_ocr.ocr(image_path, cls=True)
            return self._parse_paddle_result(result)
        else:
            text = self.tesseract.image_to_string(Image.open(image_path), lang='rus')
            return OCRResult(text=text, confidence=None)
```

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤—ã–±–æ—Ä–∞ OCR:**
```
IF image_has_tables OR image_has_complex_layout:
    use PaddleOCR  # 5-10 —Å–µ–∫, –Ω–æ —Ç–æ—á–Ω–µ–µ
ELSE:
    use Tesseract  # 1-2 —Å–µ–∫, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
```

#### 5.3 Entity Extraction (Cascading)

##### Level 1: Regex + SpaCy NER (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ, CPU)
```python
# src/services/entity_extractor.py
import re
import spacy

class Level1EntityExtractor:
    def __init__(self):
        self.nlp = spacy.load("ru_core_news_lg")  # –†—É—Å—Å–∫–∞—è –º–æ–¥–µ–ª—å

    def extract(self, text: str) -> Dict[str, Any]:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –±–∞–∑–æ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –±–µ–∑ LLM:
        - –ò–ù–ù (10/12 —Ü–∏—Ñ—Ä —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã)
        - –î–∞—Ç—ã (regex: –î–î.–ú–ú.–ì–ì–ì–ì, –î–î –º–µ—Å—è—Ü –ì–ì–ì–ì)
        - –°—É–º–º—ã (regex: —Ü–∏—Ñ—Ä—ã + '—Ä—É–±–ª–µ–π', '—Ä—É–±', 'USD')
        - –ò–º–µ–Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π (SpaCy NER: ORG)
        - –ò–º–µ–Ω–∞ –ª—é–¥–µ–π (SpaCy NER: PER)
        """
        entities = {
            'inn': self._extract_inn(text),
            'dates': self._extract_dates(text),
            'amounts': self._extract_amounts(text),
        }

        # SpaCy NER
        doc = self.nlp(text)
        entities['organizations'] = [ent.text for ent in doc.ents if ent.label_ == 'ORG']
        entities['persons'] = [ent.text for ent in doc.ents if ent.label_ == 'PER']

        return entities

    def _extract_inn(self, text: str) -> List[str]:
        # Regex + checksum validation
        inn_pattern = r'\b\d{10}(?:\d{2})?\b'
        candidates = re.findall(inn_pattern, text)
        return [inn for inn in candidates if self._validate_inn_checksum(inn)]
```

##### Level 2: Llama-3-8B / Mistral-Nemo (–î–µ—à–µ–≤–æ, API)
```python
# src/services/entity_extractor.py (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)
class Level2EntityExtractor:
    def __init__(self, llm_gateway: LLMGateway):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—à–µ–≤—É—é –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ API (OpenRouter/DeepInfra)
        self.llm = llm_gateway
        self.llm.model = "meta-llama/llama-3-8b-instruct"  # $0.10/1M tokens

    def extract_tables(self, table_block: DocumentBlock) -> List[Dict]:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π, —É—Å–ª–æ–≤–∏–π –æ–ø–ª–∞—Ç—ã
        """
        prompt = f"""–ò–∑–≤–ª–µ–∫–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –≤ JSON.

–¢–∞–±–ª–∏—Ü–∞:
{table_block.text}

–í–µ—Ä–Ω–∏ JSON –º–∞—Å—Å–∏–≤:
[
  {{"item": "...", "quantity": ..., "price": ..., "total": ...}},
  ...
]"""

        result = self.llm.call(prompt, response_format="json", temperature=0.1)
        return result

    def extract_payment_terms(self, terms_block: DocumentBlock) -> Dict:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã
        """
        prompt = f"""–ò–∑–≤–ª–µ–∫–∏ —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞.

–¢–µ–∫—Å—Ç:
{terms_block.text}

–í–µ—Ä–Ω–∏ JSON:
{{
  "payment_type": "prepayment|postpayment|...",
  "schedule": [
    {{"percentage": 30, "condition": "–ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏", "days_offset": 0}},
    {{"percentage": 70, "condition": "–ø–æ—Å–ª–µ –ø–æ—Å—Ç–∞–≤–∫–∏", "days_offset": 30}}
  ]
}}"""

        result = self.llm.call(prompt, response_format="json", temperature=0.1)
        return result
```

##### Level 3: GPT-4o / Claude 3.5 Sonnet (–î–æ—Ä–æ–≥–æ, –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤)
```python
class Level3EntityExtractor:
    def __init__(self, llm_gateway: LLMGateway):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º SOTA –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ Router
        self.llm = llm_gateway
        self.llm.model = "gpt-4o"  # $2.50/1M input, $10/1M output

    def extract_liability_rules(self, liability_block: DocumentBlock) -> List[Dict]:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —à—Ç—Ä–∞—Ñ–æ–≤ (—Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —Å–µ–∫—Ü–∏—è)

        –ü—Ä–∏–º–µ—Ä—ã:
        - "–ó–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –ü–æ—Å—Ç–∞–≤—â–∏–∫ —É–ø–ª–∞—á–∏–≤–∞–µ—Ç –Ω–µ—É—Å—Ç–æ–π–∫—É 0,1% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–µ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞"
        - "–ü—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –±–æ–ª–µ–µ 30 –¥–Ω–µ–π –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –≤–ø—Ä–∞–≤–µ —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç—å –¥–æ–≥–æ–≤–æ—Ä"
        """
        prompt = f"""–¢—ã - —é—Ä–∏—Å—Ç-—ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥–æ–≥–æ–≤–æ—Ä–∞–º. –ò–∑–≤–ª–µ–∫–∏ –í–°–ï –ø—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞.

–¢–ï–ö–°–¢ –†–ê–ó–î–ï–õ–ê "–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨ –°–¢–û–†–û–ù":
{liability_block.text}

–î–ª—è –ö–ê–ñ–î–û–ì–û –ø—Ä–∞–≤–∏–ª–∞ –≤–µ—Ä–Ω–∏:
{{
  "rule_type": "penalty|termination|compensation",
  "trigger_condition": "–æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è",
  "formula": {{
    "rate": 0.001,  // 0.1% = 0.001
    "base": "outstanding_balance|contract_value|...",
    "period": "daily|weekly|one_time",
    "cap": 0.10,  // –º–∞–∫—Å–∏–º—É–º (–µ—Å–ª–∏ –µ—Å—Ç—å)
    "min_amount": 1000  // –º–∏–Ω–∏–º—É–º (–µ—Å–ª–∏ –µ—Å—Ç—å)
  }},
  "original_text": "—Ç–æ—á–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ –∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞",
  "affected_party": "seller|buyer",
  "legal_basis": "—Å—Ç. 330 –ì–ö –†–§"
}}

–ë—É–¥—å –û–ß–ï–ù–¨ –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω –∫ –¥–µ—Ç–∞–ª—è–º —Ñ–æ—Ä–º—É–ª! –û—Ç —ç—Ç–æ–≥–æ –∑–∞–≤–∏—Å–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —à—Ç—Ä–∞—Ñ–æ–≤."""

        result = self.llm.call(
            prompt,
            response_format="json",
            temperature=0.2,  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
            use_cache=True,
            db_session=self.db
        )
        return result
```

#### 5.4 LLM Router (RouteLLM pattern)
**–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å, –∫–∞–∫—É—é –º–æ–¥–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞

```python
# src/services/llm_router.py
class LLMRouter:
    """
    –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å
    """
    def __init__(self):
        self.classifier = self._load_classifier()

    def route(self, task_type: str, text_complexity: float) -> str:
        """
        Returns: model name ("llama-3-8b", "gpt-4o-mini", "gpt-4o")
        """
        if task_type in ['inn', 'dates', 'simple_amounts']:
            return None  # –ò—Å–ø–æ–ª—å–∑—É–µ–º regex (Level 1)

        if task_type in ['tables', 'payment_terms'] and text_complexity < 0.5:
            return "llama-3-8b"  # Level 2: –¥–µ—à–µ–≤–æ

        if task_type in ['liability', 'force_majeure', 'termination']:
            return "gpt-4o"  # Level 3: –¥–æ—Ä–æ–≥–æ, –Ω–æ —Ç–æ—á–Ω–æ

        # Default: —Å—Ä–µ–¥–Ω—è—è –º–æ–¥–µ–ª—å
        return "gpt-4o-mini"

    def estimate_complexity(self, text: str) -> float:
        """
        –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ (0.0 - 1.0)
        """
        features = {
            'length': len(text),
            'has_legal_terms': bool(re.search(r'–Ω–µ—É—Å—Ç–æ–π–∫–∞|—à—Ç—Ä–∞—Ñ|–ø–µ–Ω—è|—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ', text)),
            'has_formulas': bool(re.search(r'\d+%|\d+\.\d+%', text)),
            'sentence_complexity': self._calculate_sentence_complexity(text)
        }

        # –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ ML-–º–æ–¥–µ–ª—å)
        complexity = (
            features['has_legal_terms'] * 0.4 +
            features['has_formulas'] * 0.3 +
            min(features['length'] / 1000, 1.0) * 0.3
        )

        return min(complexity, 1.0)
```

### üóÑÔ∏è Vector Search (–¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤)

**–û–ø—Ü–∏–∏:**
1. **pgvector** (PostgreSQL extension) - –ø—Ä–æ—â–µ, –º–µ–Ω—å—à–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
2. **Qdrant** (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å) - –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è MVP:** pgvector (—É–∂–µ –µ—Å—Ç—å PostgreSQL)

```sql
-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pgvector extension
CREATE EXTENSION IF NOT EXISTS vector;

-- –î–æ–±–∞–≤–ª—è–µ–º embedding –∫–æ–ª–æ–Ω–∫—É –≤ contracts_core
ALTER TABLE contracts_core
ADD COLUMN embedding vector(1536);  -- OpenAI ada-002: 1536 dimensions

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_contracts_embedding
ON contracts_core
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

```python
# src/services/semantic_search.py
from sentence_transformers import SentenceTransformer

class SemanticContractSearch:
    def __init__(self, db_session):
        self.db = db_session
        # –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ
        self.model = SentenceTransformer('sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2')

    def index_contract(self, contract_id: str, text: str):
        """
        –°–æ–∑–¥–∞–µ—Ç embedding –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
        """
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º embedding (384 dimensions)
        embedding = self.model.encode(text)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        self.db.execute(
            "UPDATE contracts_core SET embedding = :emb WHERE id = :id",
            {"emb": embedding.tolist(), "id": contract_id}
        )
        self.db.commit()

    def find_similar(self, query_text: str, limit: int = 10) -> List[Dict]:
        """
        –ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Ö–æ–∂–∏–µ –¥–æ–≥–æ–≤–æ—Ä—ã –ø–æ —Å–µ–º–∞–Ω—Ç–∏–∫–µ
        """
        query_embedding = self.model.encode(query_text)

        # Cosine similarity search –≤ PostgreSQL
        results = self.db.execute("""
            SELECT
                id, doc_number,
                1 - (embedding <=> :query_emb) as similarity
            FROM contracts_core
            WHERE embedding IS NOT NULL
            ORDER BY embedding <=> :query_emb
            LIMIT :limit
        """, {"query_emb": query_embedding.tolist(), "limit": limit})

        return [dict(row) for row in results]
```

### üì¶ Storage (S3-compatible)

**–û–ø—Ü–∏–∏:**
1. **MinIO** (self-hosted S3-compatible)
2. **AWS S3** (–µ—Å–ª–∏ –≤ –æ–±–ª–∞–∫–µ)
3. **Local filesystem** (–¥–ª—è MVP)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è MVP:** Local filesystem ‚Üí MinIO (–ø—Ä–∏ —Ä–æ—Å—Ç–µ)

```python
# src/services/file_storage.py
from pathlib import Path
import shutil

class FileStorage:
    """
    –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ (–ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ S3 –ø–æ–∑–∂–µ)
    """
    def __init__(self, base_path: str = "data/contracts"):
        self.base_path = Path(base_path)
        self.base_path.mkdir(parents=True, exist_ok=True)

    def store_original(self, contract_id: str, file_data: bytes, extension: str) -> str:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        file_path = self.base_path / "originals" / f"{contract_id}{extension}"
        file_path.parent.mkdir(exist_ok=True)
        file_path.write_bytes(file_data)
        return str(file_path)

    def store_processed(self, contract_id: str, stage: str, data: dict):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
        stage_path = self.base_path / "processed" / contract_id / f"{stage}.json"
        stage_path.parent.mkdir(parents=True, exist_ok=True)
        stage_path.write_text(json.dumps(data, ensure_ascii=False, indent=2))
```

---

## 6. –ü–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### üîÑ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –≠–¢–ê–ü 1: INGESTION & ROUTING                                     ‚îÇ
‚îÇ (IDPOrchestrator)                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ Classify file ‚îÇ
        ‚îÇ   type/format ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ           ‚îÇ           ‚îÇ           ‚îÇ
    ‚ñº           ‚ñº           ‚ñº           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ XML  ‚îÇ   ‚îÇSearch‚îÇ   ‚îÇScan  ‚îÇ   ‚îÇImage ‚îÇ
‚îÇ Doc  ‚îÇ   ‚îÇ PDF  ‚îÇ   ‚îÇ PDF  ‚îÇ   ‚îÇ/JPG  ‚îÇ
‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
   ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –≠–¢–ê–ü 2: SEGMENTATION                                            ‚îÇ
‚îÇ (LayoutAnalyzer - LayoutLMv3)                                   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ Input:  PDF/Image pages                                        ‚îÇ
‚îÇ Output: Document blocks with types and bounding boxes          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ Blocks: [Header, Preamble, Terms, Payment_Table, Signatures]   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –≠–¢–ê–ü 3: CASCADING EXTRACTION                                    ‚îÇ
‚îÇ (EntityExtractor - 3 levels)                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ           ‚îÇ           ‚îÇ           ‚îÇ
    ‚ñº           ‚ñº           ‚ñº           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇLevel1‚îÇ   ‚îÇLevel2‚îÇ   ‚îÇLevel3‚îÇ   ‚îÇ OCR  ‚îÇ
‚îÇRegex ‚îÇ   ‚îÇLlama3‚îÇ   ‚îÇGPT-4o‚îÇ   ‚îÇPaddle‚îÇ
‚îÇSpaCy ‚îÇ   ‚îÇ 8B   ‚îÇ   ‚îÇClaude‚îÇ   ‚îÇTess. ‚îÇ
‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
   ‚îÇ          ‚îÇ          ‚îÇ          ‚îÇ
   ‚îÇ INN,     ‚îÇ Tables,  ‚îÇLiability ‚îÇ Text ‚îÇ
   ‚îÇ Dates,   ‚îÇ Payment  ‚îÇ Rules,   ‚îÇ from ‚îÇ
   ‚îÇ Amounts  ‚îÇ Terms    ‚îÇ Complex  ‚îÇScans ‚îÇ
   ‚îÇ          ‚îÇ          ‚îÇ Clauses  ‚îÇ      ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –≠–¢–ê–ü 4: NORMALIZATION & VALIDATION                              ‚îÇ
‚îÇ (IDPProcessor)                                                  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ 1. Merge results from all levels                               ‚îÇ
‚îÇ 2. Resolve conflicts (prefer Level 3 > Level 2 > Level 1)      ‚îÇ
‚îÇ 3. Validate with Pydantic models                               ‚îÇ
‚îÇ 4. Create Intermediate JSON                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
        Intermediate JSON
        {
          "doc_number": "123/2024",
          "parties": [...],
          "items": [...],
          "payment_schedule": [...],
          "rules": [...]
        }
                ‚îÇ
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –≠–¢–ê–ü 5: STORAGE (Hybrid Star Schema)                           ‚îÇ
‚îÇ (SchemaMapper)                                                  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ 1. Standard fields ‚Üí contracts_core columns                    ‚îÇ
‚îÇ 2. Dynamic fields ‚Üí contracts_core.attributes (JSONB)          ‚îÇ
‚îÇ 3. Parties ‚Üí contract_parties table                            ‚îÇ
‚îÇ 4. Items ‚Üí contract_items table                                ‚îÇ
‚îÇ 5. Payments ‚Üí payment_schedule table                           ‚îÇ
‚îÇ 6. Rules ‚Üí contract_rules table                                ‚îÇ
‚îÇ 7. Full JSON ‚Üí contracts_core.raw_data (audit)                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
        ‚úÖ CONTRACT STORED
        Ready for querying & analysis
```

### üìù –î–µ—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞

#### –≠—Ç–∞–ø 1: Ingestion & Routing
**–§–∞–π–ª:** `src/services/idp_orchestrator.py`

```python
class IDPOrchestrator:
    """
    –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å IDP
    """
    def __init__(self, db_session, llm_gateway, file_storage):
        self.db = db_session
        self.llm = llm_gateway
        self.storage = file_storage

        # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–∞–π–ø–ª–∞–π–Ω–∞
        self.classifier = DocumentClassifier()
        self.layout_analyzer = LayoutAnalyzer()
        self.ocr_service = EnhancedOCRService()
        self.entity_extractor = MultiLevelEntityExtractor(llm_gateway)
        self.schema_mapper = SchemaMapper(db_session)

    async def process_document(
        self,
        contract_id: str,
        file_data: bytes,
        filename: str
    ) -> ProcessingResult:
        """
        –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        """
        logger.info(f"Starting IDP processing for contract {contract_id}")

        # 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
        file_path = self.storage.store_original(
            contract_id, file_data, Path(filename).suffix
        )

        # 2. –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
        doc_type = self.classifier.classify(file_path)
        self._log_stage(contract_id, 'classification', doc_type)

        # 3. –í—ã–±–∏—Ä–∞–µ–º –ø–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏
        if doc_type.format == 'xml':
            result = await self._process_xml(contract_id, file_path)
        elif doc_type.format == 'pdf' and doc_type.is_searchable:
            result = await self._process_searchable_pdf(contract_id, file_path)
        elif doc_type.format in ['pdf', 'jpg', 'png']:
            result = await self._process_scanned_document(contract_id, file_path)
        else:
            raise UnsupportedFormatError(f"Format {doc_type.format} not supported")

        # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        await self.schema_mapper.save_to_database(contract_id, result)

        logger.info(f"IDP processing completed for contract {contract_id}")
        return result

    async def _process_xml(self, contract_id: str, file_path: str) -> IntermediateJSON:
        """
        –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ XML (–±—ã—Å—Ç—Ä–æ, –¥–µ—à–µ–≤–æ)
        """
        from src.services.document_parser import DocumentParser

        parser = DocumentParser()
        xml_data = parser.parse(file_path)

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º XML ‚Üí Intermediate JSON
        intermediate = self._xml_to_intermediate(xml_data)

        self._log_stage(contract_id, 'xml_parsing', {
            'success': True,
            'extracted_fields': len(intermediate.keys())
        })

        return intermediate

    async def _process_searchable_pdf(self, contract_id: str, file_path: str) -> IntermediateJSON:
        """
        PDF —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º —Å–ª–æ–µ–º (—Å—Ä–µ–¥–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å)
        OCR –Ω–µ –Ω—É–∂–µ–Ω, –Ω–æ –Ω—É–∂–Ω–∞ layout analysis
        """
        # 1. Layout segmentation
        pages = convert_pdf_to_images(file_path)
        blocks = []
        for page_num, page_img in enumerate(pages):
            page_blocks = self.layout_analyzer.segment_document(page_img)
            blocks.extend(page_blocks)

        self._log_stage(contract_id, 'layout_analysis', {
            'pages': len(pages),
            'blocks': len(blocks)
        })

        # 2. Cascading extraction
        intermediate = await self.entity_extractor.extract_all(blocks)

        return intermediate

    async def _process_scanned_document(self, contract_id: str, file_path: str) -> IntermediateJSON:
        """
        –°–∫–∞–Ω –∏–ª–∏ —Ñ–æ—Ç–æ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å)
        –ù—É–∂–Ω—ã OCR + layout analysis + LLM
        """
        pages = convert_pdf_to_images(file_path)

        # 1. OCR –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        ocr_results = []
        for page_num, page_img in enumerate(pages):
            ocr_result = self.ocr_service.extract_text(
                page_img,
                prefer_structure=True  # PaddleOCR
            )
            ocr_results.append(ocr_result)

        self._log_stage(contract_id, 'ocr', {
            'pages': len(pages),
            'avg_confidence': sum(r.confidence for r in ocr_results) / len(ocr_results)
        })

        # 2. Layout segmentation
        blocks = []
        for page_num, page_img in enumerate(pages):
            page_blocks = self.layout_analyzer.segment_document(page_img)
            # –û–±–æ–≥–∞—â–∞–µ–º –±–ª–æ–∫–∏ —Ç–µ–∫—Å—Ç–æ–º –∏–∑ OCR
            for block in page_blocks:
                block.text = self._extract_text_from_ocr(
                    ocr_results[page_num], block.bbox
                )
            blocks.extend(page_blocks)

        self._log_stage(contract_id, 'layout_analysis', {
            'pages': len(pages),
            'blocks': len(blocks)
        })

        # 3. Cascading extraction
        intermediate = await self.entity_extractor.extract_all(blocks)

        return intermediate

    def _log_stage(self, contract_id: str, stage: str, output_data: dict):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
        log_entry = IDPExtractionLog(
            contract_id=contract_id,
            stage=stage,
            status='success',
            output_data=output_data,
            created_at=datetime.now()
        )
        self.db.add(log_entry)
        self.db.commit()
```

#### –≠—Ç–∞–ø 2: Segmentation (Layout Analysis)
**–§–∞–π–ª:** `src/services/layout_analyzer.py`

```python
class LayoutAnalyzer:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –ø–æ–º–æ—â—å—é LayoutLMv3
    """
    def __init__(self):
        self.model_path = "models/layoutlmv3-contract-segmentation.onnx"
        self.session = onnxruntime.InferenceSession(self.model_path)

        # –ö–ª–∞—Å—Å—ã –±–ª–æ–∫–æ–≤
        self.block_types = [
            'header', 'preamble', 'subject',
            'terms', 'payment_table', 'liability',
            'signatures', 'footer', 'other'
        ]

    def segment_document(self, image_path: str) -> List[DocumentBlock]:
        """
        –†–∞–∑–±–∏–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –±–ª–æ–∫–∏ —Å —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π

        Returns:
            List[DocumentBlock]: –°–ø–∏—Å–æ–∫ –±–ª–æ–∫–æ–≤ —Å —Ç–∏–ø–∞–º–∏ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
        """
        # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        image = Image.open(image_path).convert('RGB')

        # 2. –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ –¥–ª—è LayoutLM
        inputs = self._preprocess_image(image)

        # 3. Inference —á–µ—Ä–µ–∑ ONNX (CPU, ~3-5 —Å–µ–∫)
        onnx_inputs = {self.session.get_inputs()[0].name: inputs}
        outputs = self.session.run(None, onnx_inputs)

        # 4. –ü–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥: –∏–∑–≤–ª–µ–∫–∞–µ–º bounding boxes –∏ —Ç–∏–ø—ã
        blocks = self._postprocess_outputs(outputs, image.size)

        logger.info(f"Segmented page into {len(blocks)} blocks")
        return blocks

    def _preprocess_image(self, image: Image) -> np.ndarray:
        """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è LayoutLM"""
        # Resize to 224x224 (LayoutLMv3 input size)
        image = image.resize((224, 224))
        image_array = np.array(image).astype(np.float32) / 255.0
        image_array = np.transpose(image_array, (2, 0, 1))  # HWC -> CHW
        image_array = np.expand_dims(image_array, axis=0)  # Add batch dim
        return image_array

    def _postprocess_outputs(self, outputs, image_size) -> List[DocumentBlock]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –±–ª–æ–∫–∏ –∏–∑ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –º–æ–¥–µ–ª–∏"""
        predictions = outputs[0]  # Shape: (1, num_boxes, 4 + num_classes)

        blocks = []
        for pred in predictions[0]:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º bbox –∏ –∫–ª–∞—Å—Å
            bbox = pred[:4]  # [x1, y1, x2, y2] normalized
            class_scores = pred[4:]
            class_id = np.argmax(class_scores)
            confidence = class_scores[class_id]

            if confidence > 0.5:  # Threshold
                # –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                x1, y1, x2, y2 = bbox
                width, height = image_size
                bbox_abs = (
                    int(x1 * width), int(y1 * height),
                    int(x2 * width), int(y2 * height)
                )

                block = DocumentBlock(
                    type=self.block_types[class_id],
                    bbox=bbox_abs,
                    confidence=float(confidence),
                    text=""  # –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –ø–æ—Å–ª–µ OCR/extraction
                )
                blocks.append(block)

        return blocks
```

#### –≠—Ç–∞–ø 3: Cascading Extraction
**–§–∞–π–ª:** `src/services/entity_extractor.py`

```python
class MultiLevelEntityExtractor:
    """
    –ö–∞—Å–∫–∞–¥–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π —Å 3 —É—Ä–æ–≤–Ω—è–º–∏
    """
    def __init__(self, llm_gateway: LLMGateway):
        self.level1 = Level1EntityExtractor()  # Regex + SpaCy
        self.level2 = Level2EntityExtractor(llm_gateway)  # Llama-3-8B
        self.level3 = Level3EntityExtractor(llm_gateway)  # GPT-4o
        self.router = LLMRouter()

    async def extract_all(self, blocks: List[DocumentBlock]) -> IntermediateJSON:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–ª–æ–∫–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        """
        intermediate = IntermediateJSON()

        for block in blocks:
            logger.info(f"Processing block type: {block.type}")

            if block.type == 'header':
                # Level 1: Regex –¥–ª—è –Ω–æ–º–µ—Ä–∞ –∏ –¥–∞—Ç—ã –¥–æ–≥–æ–≤–æ—Ä–∞
                intermediate.update(self.level1.extract_header(block.text))

            elif block.type == 'preamble':
                # Level 1: Regex + SpaCy –¥–ª—è —Å—Ç–æ—Ä–æ–Ω
                parties = self.level1.extract_parties(block.text)
                intermediate['parties'] = parties

            elif block.type == 'payment_table':
                # Level 2: Llama-3 –¥–ª—è —Ç–∞–±–ª–∏—Ü
                items = await self.level2.extract_tables(block)
                intermediate['items'] = items

            elif block.type == 'terms':
                # Level 2: Llama-3 –¥–ª—è —É—Å–ª–æ–≤–∏–π –æ–ø–ª–∞—Ç—ã
                payment_schedule = await self.level2.extract_payment_terms(block)
                intermediate['payment_schedule'] = payment_schedule

            elif block.type == 'liability':
                # Level 3: GPT-4o –¥–ª—è –ø—Ä–∞–≤–∏–ª –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (—Å–ª–æ–∂–Ω–æ!)
                rules = await self.level3.extract_liability_rules(block)
                intermediate['rules'] = rules

            elif block.type == 'signatures':
                # Level 1: –î–µ—Ç–µ–∫—Ç–æ—Ä –ø–æ–¥–ø–∏—Å–µ–π (computer vision)
                signatures = self._detect_signatures(block)
                intermediate['signatures'] = signatures

        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤
        intermediate = self._validate_and_fill_gaps(intermediate)

        return intermediate

    def _validate_and_fill_gaps(self, data: IntermediateJSON) -> IntermediateJSON:
        """
        –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤
        """
        from src.schemas.contract_schemas import ContractCoreSchema

        try:
            # Pydantic –≤–∞–ª–∏–¥–∞—Ü–∏—è
            validated = ContractCoreSchema(**data)
            return validated.dict()
        except ValidationError as e:
            # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            logger.warning(f"Validation errors: {e}")

            # –ü–æ–º–µ—á–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            for error in e.errors():
                field = error['loc'][0]
                self._create_quality_issue(
                    field=field,
                    issue_type='validation_error',
                    severity='warning',
                    description=error['msg']
                )

            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –µ—Å—Ç—å (—Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏)
            return data
```

#### –≠—Ç–∞–ø 4: Normalization & Storage
**–§–∞–π–ª:** `src/services/schema_mapper.py`

```python
class SchemaMapper:
    """
    –ú–∞–ø–ø–∏–Ω–≥ Intermediate JSON ‚Üí Hybrid Star Schema
    """
    def __init__(self, db_session):
        self.db = db_session

    async def save_to_database(
        self,
        contract_id: str,
        intermediate: IntermediateJSON
    ) -> str:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–æ–≥–æ–≤–æ—Ä –≤ –ë–î —Å–æ–≥–ª–∞—Å–Ω–æ Hybrid Star Schema
        """
        logger.info(f"Mapping contract {contract_id} to database schema")

        # 1. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ contracts_core
        core_record = self._map_to_core(contract_id, intermediate)
        self.db.add(core_record)
        self.db.flush()  # –ü–æ–ª—É—á–∞–µ–º ID

        # 2. –°—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞
        for party_data in intermediate.get('parties', []):
            party = self._map_to_party(core_record.id, party_data)
            self.db.add(party)

        # 3. –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
        for item_data in intermediate.get('items', []):
            item = self._map_to_item(core_record.id, item_data)
            self.db.add(item)

        # 4. –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π
        for payment_data in intermediate.get('payment_schedule', []):
            payment = self._map_to_payment(core_record.id, payment_data)
            self.db.add(payment)

        # 5. –ü—Ä–∞–≤–∏–ª–∞
        for rule_data in intermediate.get('rules', []):
            rule = self._map_to_rule(core_record.id, rule_data)
            self.db.add(rule)

        self.db.commit()

        logger.info(f"Contract {contract_id} saved to database: {core_record.id}")
        return core_record.id

    def _map_to_core(self, contract_id: str, data: dict) -> ContractCore:
        """
        –ú–∞–ø–ø–∏–Ω–≥ –≤ contracts_core
        """
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è
        standard_fields = {
            'doc_number': data.get('doc_number'),
            'signed_date': data.get('signed_date'),
            'status': 'active',
            'total_amount': data.get('total_amount'),
            'currency': data.get('currency', 'RUB'),
            'source_file_id': contract_id,
            'processed_by': 'idp_pipeline'
        }

        # –ì–∏–±–∫–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ)
        known_keys = {'doc_number', 'signed_date', 'total_amount', 'currency',
                      'parties', 'items', 'payment_schedule', 'rules'}
        attributes = {
            k: v for k, v in data.items()
            if k not in known_keys and v is not None
        }

        # –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è –∞—É–¥–∏—Ç–∞)
        raw_data = data.copy()

        return ContractCore(
            **standard_fields,
            attributes=attributes,
            raw_data=raw_data
        )

    def _map_to_party(self, core_id: str, party_data: dict) -> ContractParty:
        """–ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞"""
        return ContractParty(
            contract_id=core_id,
            role=party_data.get('role', 'unknown'),
            name=party_data['name'],
            tax_id=party_data.get('inn'),
            registration_number=party_data.get('ogrn'),
            legal_address=party_data.get('address'),
            bank_details=party_data.get('bank_details', {})
        )

    def _map_to_item(self, core_id: str, item_data: dict) -> ContractItem:
        """–ú–∞–ø–ø–∏–Ω–≥ –ø–æ–∑–∏—Ü–∏–∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        return ContractItem(
            contract_id=core_id,
            line_number=item_data.get('line_number', 1),
            name=item_data['name'],
            description=item_data.get('description'),
            quantity=item_data['quantity'],
            unit=item_data.get('unit', '—à—Ç'),
            price_unit=item_data['price'],
            total_line=item_data['total'],
            sku_code=item_data.get('sku'),
            attributes=item_data.get('attributes', {})
        )

    def _map_to_payment(self, core_id: str, payment_data: dict) -> PaymentSchedule:
        """–ú–∞–ø–ø–∏–Ω–≥ —É—Å–ª–æ–≤–∏–π –æ–ø–ª–∞—Ç—ã"""
        return PaymentSchedule(
            contract_id=core_id,
            payment_type=payment_data.get('type', 'postpayment'),
            amount=payment_data['amount'],
            percentage=payment_data.get('percentage'),
            due_date=payment_data.get('due_date'),
            due_condition=payment_data.get('condition'),
            days_offset=payment_data.get('days_offset'),
            trigger_event=payment_data.get('trigger'),
            status='pending'
        )

    def _map_to_rule(self, core_id: str, rule_data: dict) -> ContractRule:
        """–ú–∞–ø–ø–∏–Ω–≥ –ø—Ä–∞–≤–∏–ª –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏"""
        return ContractRule(
            contract_id=core_id,
            section_type=rule_data.get('rule_type', 'liability'),
            rule_name=rule_data['title'],
            trigger_condition=rule_data.get('trigger_condition'),
            formula=rule_data['formula'],
            original_text=rule_data['original_text'],
            clause_location=rule_data.get('xpath'),
            extracted_by='llm_' + rule_data.get('model', 'gpt4o'),
            confidence_score=rule_data.get('confidence', 0.9),
            is_active=True
        )
```

---

## 7. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π

### üîå –¢–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

#### 7.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ API (FastAPI routes)
**–§–∞–π–ª:** `src/api/contracts/routes.py` (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ)

```python
# ========== –ù–û–í–´–ï –≠–ù–î–ü–û–ò–ù–¢–´ IDP ==========

@router.post("/upload-idp", response_model=ContractUploadResponse)
async def upload_contract_idp(
    file: UploadFile = File(...),
    enable_idp: bool = Form(True),  # –í–∫–ª—é—á–∏—Ç—å IDP –æ–±—Ä–∞–±–æ—Ç–∫—É
    idp_mode: str = Form("auto"),  # auto, fast, deep
    current_user: User = Depends(get_current_user),
    background_tasks: BackgroundTasks,
    db: Session = Depends(get_db)
):
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ —Å IDP –æ–±—Ä–∞–±–æ—Ç–∫–æ–π

    idp_mode:
    - auto: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ø–∞–π–ø–ª–∞–π–Ω–∞
    - fast: –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–±–µ–∑ LLM Level 3)
    - deep: –ì–ª—É–±–æ–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–≤—Å–µ —É—Ä–æ–≤–Ω–∏ LLM)
    """
    file_data = await file.read()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
    file_path, safe_filename, file_size = save_uploaded_file_securely(
        file_data, file.filename, "data/contracts"
    )

    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ —Å—Ç–∞—Ä–æ–π —Ç–∞–±–ª–∏—Ü–µ contracts
    contract = Contract(
        file_name=safe_filename,
        file_path=file_path,
        document_type='contract',
        status='processing',
        assigned_to=current_user.id
    )
    db.add(contract)
    db.commit()
    db.refresh(contract)

    if enable_idp:
        # –ó–∞–ø—É—Å–∫–∞–µ–º IDP –≤ —Ñ–æ–Ω–µ
        background_tasks.add_task(
            process_contract_idp_background,
            contract_id=contract.id,
            file_data=file_data,
            filename=safe_filename,
            idp_mode=idp_mode,
            db=db
        )

        return ContractUploadResponse(
            contract_id=contract.id,
            file_name=safe_filename,
            file_size=file_size,
            status='processing_idp',
            message='IDP processing started. Check /api/v1/idp/status/{contract_id}'
        )
    else:
        # –°—Ç–∞—Ä—ã–π –ø–∞–π–ø–ª–∞–π–Ω (DocumentParser)
        background_tasks.add_task(
            analyze_contract_background,  # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è
            contract_id=contract.id,
            user_id=current_user.id,
            check_counterparty=True,
            counterparty_tin=None,
            db=db
        )

        return ContractUploadResponse(
            contract_id=contract.id,
            file_name=safe_filename,
            file_size=file_size,
            status='processing_legacy',
            message='Legacy processing started'
        )


@router.get("/idp/status/{contract_id}")
async def get_idp_status(
    contract_id: str,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ IDP –æ–±—Ä–∞–±–æ—Ç–∫–∏
    """
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å–∏ –∏–∑ idp_extraction_log
    logs = db.query(IDPExtractionLog).filter(
        IDPExtractionLog.contract_id == contract_id
    ).order_by(IDPExtractionLog.created_at.desc()).all()

    if not logs:
        raise HTTPException(404, "IDP processing not found")

    # –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞
    latest_log = logs[0]

    # –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
    stages = ['classification', 'layout_analysis', 'entity_extraction',
              'validation', 'storage']
    completed_stages = {log.stage for log in logs if log.status == 'success'}
    progress = len(completed_stages) / len(stages) * 100

    return {
        'contract_id': contract_id,
        'status': latest_log.status,
        'current_stage': latest_log.stage,
        'progress': progress,
        'stages': [
            {
                'stage': log.stage,
                'status': log.status,
                'duration_ms': log.duration_ms,
                'completed_at': log.created_at.isoformat()
            }
            for log in logs
        ],
        'total_cost_usd': sum(log.cost_usd or 0 for log in logs),
        'total_tokens': sum(log.tokens_used or 0 for log in logs)
    }


@router.get("/idp/result/{contract_id}")
async def get_idp_result(
    contract_id: str,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ IDP
    """
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å—å –∏–∑ contracts_core
    core = db.query(ContractCore).filter(
        ContractCore.source_file_id == contract_id
    ).first()

    if not core:
        raise HTTPException(404, "IDP result not found")

    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    parties = db.query(ContractParty).filter(
        ContractParty.contract_id == core.id
    ).all()

    items = db.query(ContractItem).filter(
        ContractItem.contract_id == core.id
    ).all()

    payments = db.query(PaymentSchedule).filter(
        PaymentSchedule.contract_id == core.id
    ).all()

    rules = db.query(ContractRule).filter(
        ContractRule.contract_id == core.id
    ).all()

    return {
        'contract': {
            'id': core.id,
            'doc_number': core.doc_number,
            'signed_date': core.signed_date.isoformat() if core.signed_date else None,
            'status': core.status,
            'total_amount': float(core.total_amount) if core.total_amount else None,
            'currency': core.currency,
            'attributes': core.attributes  # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è
        },
        'parties': [
            {
                'role': p.role,
                'name': p.name,
                'tax_id': p.tax_id,
                'legal_address': p.legal_address
            }
            for p in parties
        ],
        'items': [
            {
                'line_number': i.line_number,
                'name': i.name,
                'quantity': float(i.quantity),
                'unit': i.unit,
                'price_unit': float(i.price_unit),
                'total': float(i.total_line)
            }
            for i in items
        ],
        'payment_schedule': [
            {
                'type': ps.payment_type,
                'amount': float(ps.amount),
                'due_date': ps.due_date.isoformat() if ps.due_date else None,
                'condition': ps.due_condition,
                'status': ps.status
            }
            for ps in payments
        ],
        'rules': [
            {
                'type': r.section_type,
                'name': r.rule_name,
                'trigger': r.trigger_condition,
                'formula': r.formula,
                'original_text': r.original_text,
                'confidence': float(r.confidence_score) if r.confidence_score else None
            }
            for r in rules
        ]
    }
```

#### 7.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ContractAnalyzerAgent
**–§–∞–π–ª:** `src/agents/contract_analyzer_agent.py` (–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è)

```python
class ContractAnalyzerAgent(BaseAgent):
    """
    –†–∞—Å—à–∏—Ä—è–µ–º –∞–≥–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å IDP –¥–∞–Ω–Ω—ã–º–∏
    """
    def execute(self, state: Dict[str, Any]) -> AgentResult:
        contract_id = state.get('contract_id')

        # –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ IDP –¥–∞–Ω–Ω—ã–µ
        core = self.db.query(ContractCore).filter(
            ContractCore.source_file_id == contract_id
        ).first()

        if core:
            # üÜï –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ IDP
            logger.info(f"Contract {contract_id} has IDP data, using structured analysis")
            return self._analyze_with_idp_data(contract_id, core)
        else:
            # –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞: –ø–∞—Ä—Å–∏–º XML
            logger.info(f"Contract {contract_id} has no IDP data, using legacy XML analysis")
            return self._analyze_legacy(contract_id, state)

    def _analyze_with_idp_data(self, contract_id: str, core: ContractCore) -> AgentResult:
        """
        –ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö IDP –¥–∞–Ω–Ω—ã—Ö
        """
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        parties = self.db.query(ContractParty).filter(...).all()
        items = self.db.query(ContractItem).filter(...).all()
        rules = self.db.query(ContractRule).filter(...).all()

        # –ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ü–†–ê–í–ò–õ (contract_rules)
        risks = []
        for rule in rules:
            if rule.section_type == 'penalty':
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º—É–ª—É —à—Ç—Ä–∞—Ñ–∞
                penalty_risk = self._analyze_penalty_rule(rule)
                if penalty_risk:
                    risks.append(penalty_risk)

            elif rule.section_type == 'termination':
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏—è
                termination_risk = self._analyze_termination_rule(rule)
                if termination_risk:
                    risks.append(termination_risk)

        # –ê–Ω–∞–ª–∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∏—Å–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ ITEMS –∏ PAYMENTS
        financial_risks = self._analyze_financial_structure(items, payments)
        risks.extend(financial_risks)

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        recommendations = self.recommendation_generator.generate_recommendations(
            risks, rag_context={}
        )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        analysis = AnalysisResult(
            contract_id=contract_id,
            risks=json.dumps([r.dict() for r in risks]),
            recommendations=json.dumps([rec.dict() for rec in recommendations])
        )
        self.db.add(analysis)
        self.db.commit()

        return AgentResult(
            success=True,
            data={
                'analysis_id': analysis.id,
                'risks': risks,
                'recommendations': recommendations,
                'structured_data_used': True  # –§–ª–∞–≥ IDP
            }
        )

    def _analyze_penalty_rule(self, rule: ContractRule) -> Optional[ContractRisk]:
        """
        –ê–Ω–∞–ª–∏–∑ –ø—Ä–∞–≤–∏–ª–∞ —à—Ç—Ä–∞—Ñ–∞ –∏–∑ contract_rules
        """
        formula = rule.formula

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—É–º–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º—É–ª—ã
        if formula.get('rate', 0) > 0.01:  # >1% –≤ –¥–µ–Ω—å
            return ContractRisk(
                risk_type='financial',
                severity='high',
                title='Excessive penalty rate',
                description=f"Penalty rate {formula['rate']*100}% per {formula['period']} is very high",
                original_text=rule.original_text,
                clause_location=rule.clause_location
            )

        return None
```

#### 7.3 Backwards Compatibility (–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**
1. **–î–≤–æ–π–Ω–∞—è –∑–∞–ø–∏—Å—å:** –ü—Ä–∏ IDP –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ò –≤ —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã (`contracts`), –ò –≤ –Ω–æ–≤—ã–µ (`contracts_core`)
2. **Graceful fallback:** –ï—Å–ª–∏ IDP –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π DocumentParser
3. **–ú–∏–≥—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è:** –°—Ç–∞—Ä—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ `contracts`, –Ω–æ–≤—ã–µ ‚Üí `contracts_core`

```python
# src/services/backward_compatibility.py
class BackwardCompatibilityLayer:
    """
    –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –º–µ–∂–¥—É —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–∞–º–∏
    """
    def __init__(self, db_session):
        self.db = db_session

    def sync_old_to_new(self, contract_id: str):
        """
        –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å –∏–∑ contracts ‚Üí contracts_core
        """
        old_contract = self.db.query(Contract).filter(Contract.id == contract_id).first()

        if not old_contract:
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤ contracts_core
        core = self.db.query(ContractCore).filter(
            ContractCore.source_file_id == contract_id
        ).first()

        if core:
            return  # –£–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

        # –ü–∞—Ä—Å–∏–º meta_info (XML)
        if old_contract.meta_info:
            try:
                xml_data = json.loads(old_contract.meta_info).get('xml', '')
                intermediate = self._xml_to_intermediate(xml_data)

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–æ–≤—É—é —Å—Ö–µ–º—É
                mapper = SchemaMapper(self.db)
                mapper.save_to_database(contract_id, intermediate)

                logger.info(f"Synced old contract {contract_id} to new schema")
            except Exception as e:
                logger.error(f"Failed to sync contract {contract_id}: {e}")
```

---

## 8. API –∫–æ–Ω—Ç—Ä–∞–∫—Ç

### üì° REST API Endpoints

```yaml
# ==================== IDP ENDPOINTS ====================

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ —Å IDP
POST /api/v1/contracts/upload-idp
  Body (multipart/form-data):
    - file: binary
    - enable_idp: boolean (default: true)
    - idp_mode: "auto" | "fast" | "deep"
  Response:
    {
      "contract_id": "uuid",
      "status": "processing_idp",
      "message": "IDP processing started"
    }

# –°—Ç–∞—Ç—É—Å IDP –æ–±—Ä–∞–±–æ—Ç–∫–∏
GET /api/v1/contracts/idp/status/{contract_id}
  Response:
    {
      "contract_id": "uuid",
      "status": "success",
      "current_stage": "storage",
      "progress": 100,
      "stages": [
        {
          "stage": "classification",
          "status": "success",
          "duration_ms": 120,
          "completed_at": "2024-01-08T10:00:00"
        },
        ...
      ],
      "total_cost_usd": 0.25,
      "total_tokens": 5000
    }

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
GET /api/v1/contracts/idp/result/{contract_id}
  Response:
    {
      "contract": {
        "id": "uuid",
        "doc_number": "123/2024",
        "signed_date": "2024-01-01",
        "total_amount": 1000000,
        "currency": "RUB",
        "attributes": {
          "delivery_type": "air",
          "project_manager": "Ivanov"
        }
      },
      "parties": [...],
      "items": [...],
      "payment_schedule": [...],
      "rules": [...]
    }

# –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (semantic search)
POST /api/v1/contracts/idp/search-similar
  Body:
    {
      "query": "–¥–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏ —Å –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–æ–π",
      "limit": 10,
      "filters": {
        "currency": "RUB",
        "min_amount": 100000
      }
    }
  Response:
    {
      "results": [
        {
          "contract_id": "uuid",
          "doc_number": "456/2024",
          "similarity": 0.92,
          "summary": "..."
        },
        ...
      ]
    }

# SQL-like –∑–∞–ø—Ä–æ—Å—ã –∫ –¥–æ–≥–æ–≤–æ—Ä–∞–º
POST /api/v1/contracts/idp/query
  Body:
    {
      "query": {
        "total_amount": {"$gt": 1000000},
        "currency": "RUB",
        "attributes.delivery_type": "air"
      },
      "sort": {"signed_date": -1},
      "limit": 20
    }
  Response:
    {
      "results": [...],
      "total": 150
    }

# –ü—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞ IDP
GET /api/v1/contracts/idp/quality-issues/{contract_id}
  Response:
    {
      "issues": [
        {
          "type": "missing_field",
          "severity": "warning",
          "field": "payment_schedule",
          "description": "Payment schedule not found in document",
          "suggested_action": "Manual review required"
        },
        ...
      ]
    }

# –≠–∫—Å–ø–æ—Ä—Ç –≤ ERP (1C, SAP)
POST /api/v1/contracts/idp/export-to-erp
  Body:
    {
      "contract_ids": ["uuid1", "uuid2"],
      "erp_system": "1c",
      "mapping_profile": "default"
    }
  Response:
    {
      "exported": 2,
      "failed": 0,
      "export_log_id": "uuid"
    }
```

### üîå WebSocket –¥–ª—è Real-time –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

```javascript
// Frontend: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
const ws = new WebSocket('ws://localhost:8000/api/v1/ws/idp/{contract_id}');

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  console.log(`Stage: ${data.stage}, Progress: ${data.progress}%`);

  if (data.stage === 'completed') {
    console.log('IDP processing completed!');
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    fetchIDPResult(contract_id);
  }
};

// Backend: WebSocket endpoint (FastAPI)
@app.websocket("/api/v1/ws/idp/{contract_id}")
async def idp_progress_websocket(websocket: WebSocket, contract_id: str):
    await websocket.accept()

    try:
        while True:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å IDP –æ–±—Ä–∞–±–æ—Ç–∫–∏
            status = await get_idp_status(contract_id)

            await websocket.send_json({
                'stage': status['current_stage'],
                'progress': status['progress'],
                'status': status['status']
            })

            if status['status'] in ['success', 'failed']:
                break

            await asyncio.sleep(2)  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã

    except WebSocketDisconnect:
        logger.info(f"WebSocket disconnected for contract {contract_id}")
```

---

## 9. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞—Ç—Ä–∞—Ç

### üí∞ –ü—Ä–∏–Ω—Ü–∏–ø—ã —ç–∫–æ–Ω–æ–º–∏–∏ –¥–ª—è MVP

#### 9.1 –ù–µ –ø–æ–∫—É–ø–∞—Ç—å GPU-—Å–µ—Ä–≤–µ—Ä—ã
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ–º CPU-inference + API-based LLM

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | Deployment | –°—Ç–æ–∏–º–æ—Å—Ç—å |
|-----------|-----------|-----------|
| LayoutLMv3 | ONNX Runtime (CPU) | $0 (–ª–æ–∫–∞–ª—å–Ω–æ) |
| PaddleOCR | CPU mode | $0 (–ª–æ–∫–∞–ª—å–Ω–æ) |
| Llama-3-8B | OpenRouter/DeepInfra API | $0.10/1M tokens |
| GPT-4o | OpenAI API | $2.50/1M input |

**–≠–∫–æ–Ω–æ–º–∏—è:** $5000-10000 –Ω–∞ GPU-—Å–µ—Ä–≤–µ—Ä–µ ‚Üí $0 –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç

#### 9.2 –ö–∞—Å–∫–∞–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (Cascading Pipeline)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Level 1: Regex + SpaCy (CPU, –±–µ—Å–ø–ª–∞—Ç–Ω–æ)                        ‚îÇ
‚îÇ –ò–∑–≤–ª–µ–∫–∞–µ—Ç: –ò–ù–ù, –¥–∞—Ç—ã, —Å—É–º–º—ã, –∏–º–µ–Ω–∞                             ‚îÇ
‚îÇ –ü–æ–∫—Ä—ã—Ç–∏–µ: ~40% –ø–æ–ª–µ–π                                            ‚îÇ
‚îÇ –°—Ç–æ–∏–º–æ—Å—Ç—å: $0                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Level 2: Llama-3-8B (API, –¥–µ—à–µ–≤–æ)                              ‚îÇ
‚îÇ –ò–∑–≤–ª–µ–∫–∞–µ—Ç: —Ç–∞–±–ª–∏—Ü—ã, —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã                             ‚îÇ
‚îÇ –ü–æ–∫—Ä—ã—Ç–∏–µ: +40% –ø–æ–ª–µ–π                                            ‚îÇ
‚îÇ –°—Ç–æ–∏–º–æ—Å—Ç—å: $0.05-0.10 –∑–∞ –¥–æ–≥–æ–≤–æ—Ä                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ –ï—Å–ª–∏ —Å–ª–æ–∂–Ω–∞—è —Å–µ–∫—Ü–∏—è ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Level 3: GPT-4o (API, –¥–æ—Ä–æ–≥–æ)                                  ‚îÇ
‚îÇ –ò–∑–≤–ª–µ–∫–∞–µ—Ç: —à—Ç—Ä–∞—Ñ—ã, —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä, —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞                 ‚îÇ
‚îÇ –ü–æ–∫—Ä—ã—Ç–∏–µ: +20% –ø–æ–ª–µ–π                                            ‚îÇ
‚îÇ –°—Ç–æ–∏–º–æ—Å—Ç—å: $0.20-0.50 –∑–∞ –¥–æ–≥–æ–≤–æ—Ä                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ò—Ç–æ–≥–æ:** $0.05-0.50 –∑–∞ –¥–æ–≥–æ–≤–æ—Ä –≤–º–µ—Å—Ç–æ $5-10 (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPT-4o –¥–ª—è –≤—Å–µ–≥–æ)

#### 9.3 LLM Caching (—É–∂–µ –µ—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ!)

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º:** `LLMCache` —Ç–∞–±–ª–∏—Ü–∞ (src/models/database.py)

**–£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è IDP:**
```python
# src/services/llm_gateway.py (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)
class LLMGateway:
    def call_with_smart_cache(self, prompt: str, **kwargs) -> Any:
        """
        –£–º–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –ø–æ—Ö–æ–∂–µ—Å—Ç–∏ –ø—Ä–æ–º–ø—Ç–æ–≤
        """
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (SHA256)
        cache_hit = self._check_cache_exact(prompt)
        if cache_hit:
            logger.info("Cache hit (exact)")
            return cache_hit['response']

        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫—É—é –ø–æ—Ö–æ–∂–µ—Å—Ç—å (cosine similarity)
        similar_cache = self._check_cache_semantic(prompt, threshold=0.95)
        if similar_cache:
            logger.info(f"Cache hit (semantic, similarity={similar_cache['similarity']})")
            return similar_cache['response']

        # 3. –í—ã–∑—ã–≤–∞–µ–º LLM
        response = self._call_llm(prompt, **kwargs)

        # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        self._save_to_cache(prompt, response, **kwargs)

        return response
```

**–≠–∫–æ–Ω–æ–º–∏—è:** 50-70% –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ –∫—ç—à–∞ –¥–ª—è —Ç–∏–ø–æ–≤—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤

#### 9.4 Batch Processing (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å)

**–í–º–µ—Å—Ç–æ Real-time ‚Üí Background processing:**

```python
# src/services/batch_processor.py
from celery import Celery

celery_app = Celery('idp_tasks', broker='redis://localhost:6379/0')

@celery_app.task
def process_contract_batch(contract_ids: List[str]):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–∞—Ç—á –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑
    –≠–∫–æ–Ω–æ–º–∏—Ç –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –æ–ø–µ—Ä–∞—Ü–∏—è—Ö (–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API)
    """
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ–≥–æ –±–∞—Ç—á–∞
    layout_analyzer = LayoutAnalyzer()
    ocr_service = EnhancedOCRService()

    results = []
    for contract_id in contract_ids:
        result = process_single_contract(
            contract_id,
            layout_analyzer,
            ocr_service
        )
        results.append(result)

    return results
```

**–≠–∫–æ–Ω–æ–º–∏—è:** 20-30% –Ω–∞ overhead (–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)

#### 9.5 –°—Ç–æ–∏–º–æ—Å—Ç–Ω–æ–π –∞–Ω–∞–ª–∏–∑ (Cost Breakdown)

**–ü—Ä–∏–º–µ—Ä: –û–±—Ä–∞–±–æ—Ç–∫–∞ 1000 –¥–æ–≥–æ–≤–æ—Ä–æ–≤/–º–µ—Å—è—Ü**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –¥–æ–≥–æ–≤–æ—Ä | –ò—Ç–æ–≥–æ/–º–µ—Å—è—Ü |
|-----------|---------------------|-------------|
| **Layout Analysis (LayoutLMv3 CPU)** | $0 | $0 |
| **OCR (PaddleOCR CPU)** | $0 | $0 |
| **Level 1 (Regex + SpaCy)** | $0 | $0 |
| **Level 2 (Llama-3-8B, 60% –¥–æ–≥–æ–≤–æ—Ä–æ–≤)** | $0.08 | $48 |
| **Level 3 (GPT-4o, 20% –¥–æ–≥–æ–≤–æ—Ä–æ–≤)** | $0.35 | $70 |
| **Embeddings (OpenAI ada-002)** | $0.001 | $1 |
| **Storage (PostgreSQL + S3)** | $0.01 | $10 |
| **Redis (cache)** | - | $10 |
| **–°–µ—Ä–≤–µ—Ä (CPU, 4 cores)** | - | $50 |
| **–ò–¢–û–ì–û** | **$0.10-0.40** | **$189/–º–µ—Å—è—Ü** |

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏:**
- Azure Form Recognizer: $1.50 –∑–∞ –¥–æ–≥–æ–≤–æ—Ä ‚Üí $1500/–º–µ—Å—è—Ü
- AWS Textract: $1.20 –∑–∞ –¥–æ–≥–æ–≤–æ—Ä ‚Üí $1200/–º–µ—Å—è—Ü
- –†—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞: $10 –∑–∞ –¥–æ–≥–æ–≤–æ—Ä ‚Üí $10000/–º–µ—Å—è—Ü

**–≠–∫–æ–Ω–æ–º–∏—è: 6x-50x**

---

## 10. –ü–ª–∞–Ω –ø–æ—ç—Ç–∞–ø–Ω–æ–≥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### üöÄ Roadmap (4 —Ñ–∞–∑—ã)

#### **Phase 1: Foundation (–ù–µ–¥–µ–ª–∏ 1-2)**
**–¶–µ–ª—å:** –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–µ–∑ AI

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î (contracts_core, contract_parties, etc.)
2. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è Alembic
3. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å SchemaMapper (–±–µ–∑ AI, —Ç–æ–ª—å–∫–æ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥)
4. ‚úÖ –†–∞—Å—à–∏—Ä–∏—Ç—å FileStorage –¥–ª—è IDP
5. ‚úÖ –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π IDPOrchestrator (–±–µ–∑ ML)
6. ‚úÖ Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –ë–î –º–æ–¥–µ–ª–µ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞, –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ã –≤ –Ω–æ–≤—É—é —Å—Ö–µ–º—É –≤—Ä—É—á–Ω—É—é

#### **Phase 2: Level 1 Extraction (–ù–µ–¥–µ–ª–∏ 3-4)**
**–¶–µ–ª—å:** –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –ø–æ–ª–µ–π –±–µ–∑ LLM

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Level1EntityExtractor (Regex + SpaCy)
   - –ò–ù–ù —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã
   - –î–∞—Ç—ã (–î–î.–ú–ú.–ì–ì–ì–ì, –î–î –º–µ—Å—è—Ü –ì–ì–ì–ì)
   - –°—É–º–º—ã —Å –≤–∞–ª—é—Ç–æ–π
   - NER –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –∏ –ª—é–¥–µ–π
2. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DocumentParser (XML ‚Üí Intermediate JSON)
3. ‚úÖ End-to-end —Ç–µ—Å—Ç: XML –¥–æ–≥–æ–≤–æ—Ä ‚Üí contracts_core
4. ‚úÖ API endpoint: POST /api/v1/contracts/upload-idp (–±–µ–∑ AI)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ XML –¥–æ–≥–æ–≤–æ—Ä—ã –±–µ–∑ AI

#### **Phase 3: Layout Analysis + OCR (–ù–µ–¥–µ–ª–∏ 5-6)**
**–¶–µ–ª—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ PDF –∏ —Å–∫–∞–Ω–æ–≤

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å PaddleOCR
2. ‚úÖ –û–±—É—á–∏—Ç—å –∏–ª–∏ fine-tune LayoutLMv3 –Ω–∞ —Ä—É—Å—Å–∫–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–∞—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å LayoutAnalyzer —Å ONNX Runtime
4. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è OCR ‚Üí Layout ‚Üí Level1
5. ‚úÖ End-to-end —Ç–µ—Å—Ç: –°–∫–∞–Ω PDF ‚Üí contracts_core
6. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: idp_extraction_log, idp_quality_issues

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å PDF –∏ —Å–∫–∞–Ω—ã (–±–µ–∑ LLM –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–ª–µ–π)

#### **Phase 4: Cascading LLM (–ù–µ–¥–µ–ª–∏ 7-8)**
**–¶–µ–ª—å:** –ü–æ–ª–Ω—ã–π IDP —Å AI

**–ó–∞–¥–∞—á–∏:**
1. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Level2EntityExtractor (Llama-3-8B)
   - –¢–∞–±–ª–∏—Ü—ã —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π
   - –£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã
2. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Level3EntityExtractor (GPT-4o)
   - –ü—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
   - –§–æ—Ä—Å-–º–∞–∂–æ—Ä
   - –£—Å–ª–æ–≤–∏—è —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏—è
3. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å LLMRouter (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏)
4. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π –≤ IDPOrchestrator
5. ‚úÖ End-to-end —Ç–µ—Å—Ç: –°–ª–æ–∂–Ω—ã–π —Å–∫–∞–Ω ‚Üí contracts_core —Å–æ –≤—Å–µ–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏
6. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ContractAnalyzerAgent
7. ‚úÖ WebSocket –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
8. ‚úÖ Monitoring dashboard (Streamlit)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è IDP —Å–∏—Å—Ç–µ–º–∞ —Å AI

### üìÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∑—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### **Phase 5: Optimization (–ù–µ–¥–µ–ª–∏ 9-10)**
1. –¢—é–Ω–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–∏–Ω–¥–µ–∫—Å—ã –ë–î, query optimization)
2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –±–æ–ª—å—à–æ–º –æ–±—ä–µ–º–µ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (100+)
3. A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: Legacy vs IDP —Ç–æ—á–Ω–æ—Å—Ç—å
4. Semantic search (pgvector integration)
5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ LLM –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

#### **Phase 6: Advanced Features (–ù–µ–¥–µ–ª–∏ 11-12)**
1. Automatic contract comparison (–Ω–∞–π—Ç–∏ –æ—Ç–ª–∏—á–∏—è –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏)
2. Contract templates learning (ML –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤)
3. Predictive analytics (–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–ø–æ—Ä–∞, –¥–µ—Ñ–æ–ª—Ç–∞)
4. ERP integration (1C, SAP)
5. Multi-language support (–∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –¥–æ–≥–æ–≤–æ—Ä—ã)

---

## 11. –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### üìä KPI –¥–ª—è –æ—Ü–µ–Ω–∫–∏ IDP —Å–∏—Å—Ç–µ–º—ã

#### 11.1 –¢–æ—á–Ω–æ—Å—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è (Accuracy Metrics)

| –ü–æ–ª–µ | –¶–µ–ª–µ–≤–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|------|------------------|-------------|
| **–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞** | 99% | Critical |
| **–î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è** | 98% | Critical |
| **–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞** | 95% | Critical |
| **–°—Ç–æ—Ä–æ–Ω—ã (–∏–º–µ–Ω–∞)** | 95% | High |
| **–ò–ù–ù** | 99% (—Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π) | High |
| **–¢–∞–±–ª–∏—Ü—ã —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π** | 85% | Medium |
| **–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã** | 85% | High |
| **–ü—Ä–∞–≤–∏–ª–∞ —à—Ç—Ä–∞—Ñ–æ–≤** | 80% | Medium |

**–ú–µ—Ç–æ–¥–∏–∫–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è:**
1. –°–æ–±—Ä–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –¥–∞—Ç–∞—Å–µ—Ç: 100 –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å —Ä—É—á–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–æ–π (ground truth)
2. –ü—Ä–æ–≥–Ω–∞—Ç—å —á–µ—Ä–µ–∑ IDP pipeline
3. –°—Ä–∞–≤–Ω–∏—Ç—å —Å ground truth: Precision, Recall, F1-score
4. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

#### 11.2 –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (Performance Metrics)

| –ú–µ—Ç—Ä–∏–∫–∞ | –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|---------|------------------|-------------|
| **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (XML)** | < 30 —Å–µ–∫ | –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ |
| **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (PDF)** | < 2 –º–∏–Ω | –° layout analysis |
| **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Å–∫–∞–Ω)** | < 5 –º–∏–Ω | –° OCR + full AI pipeline |
| **Throughput** | 20+ –¥–æ–≥–æ–≤–æ—Ä–æ–≤/—á–∞—Å | –ù–∞ 1 CPU worker |
| **Latency P95** | < 3 –º–∏–Ω | 95 –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å |

#### 11.3 –°—Ç–æ–∏–º–æ—Å—Ç—å (Cost Metrics)

| –ú–µ—Ç—Ä–∏–∫–∞ | –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|------------------|
| **–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏** | < $0.50/–¥–æ–≥–æ–≤–æ—Ä |
| **LLM tokens (—Å—Ä–µ–¥–Ω–µ–µ)** | < 10K tokens/–¥–æ–≥–æ–≤–æ—Ä |
| **% –∫—ç—à-—Ö–∏—Ç–æ–≤** | > 60% |
| **Level 3 usage** | < 30% –¥–æ–≥–æ–≤–æ—Ä–æ–≤ |

#### 11.4 –ö–∞—á–µ—Å—Ç–≤–æ (Quality Metrics)

| –ú–µ—Ç—Ä–∏–∫–∞ | –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ | –ö–∞–∫ –∏–∑–º–µ—Ä—è—Ç—å |
|---------|------------------|--------------|
| **% –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤** | > 70% | –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã |
| **% —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ—à–∏–±–∫–∞–º–∏** | < 5% | idp_quality_issues severity='critical' |
| **% —Ç—Ä–µ–±—É—é—â–∏—Ö —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏** | < 20% | requires_manual_review=True |
| **User satisfaction (—é—Ä–∏—Å—Ç—ã)** | > 4.0/5.0 | Survey –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è |

#### 11.5 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ Legacy vs IDP

**A/B —Ç–µ—Å—Ç –Ω–∞ 200 –¥–æ–≥–æ–≤–æ—Ä–∞—Ö:**

| –ú–µ—Ç—Ä–∏–∫–∞ | Legacy (DocumentParser) | IDP | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-------------------------|-----|-----------|
| –¢–æ—á–Ω–æ—Å—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É–º–º | 65% | 92% | +27% |
| –¢–æ—á–Ω–æ—Å—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞—Ç | 70% | 95% | +25% |
| –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —à—Ç—Ä–∞—Ñ–æ–≤ | 0% (–Ω–µ —É–º–µ–µ—Ç) | 75% | +75% |
| –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ | 5 –º–∏–Ω (—Ä—É—á–Ω–∞—è) | 2 –º–∏–Ω (–∞–≤—Ç–æ) | 2.5x |
| –°—Ç–æ–∏–º–æ—Å—Ç—å | $8 (—á–µ–ª–æ–≤–µ–∫) | $0.30 (AI) | 26x |

---

## 12. –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|---------|-----------|
| **–ù–∏–∑–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å OCR –Ω–∞ –ø–ª–æ—Ö–∏—Ö —Å–∫–∞–Ω–∞—Ö** | High | High | 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PaddleOCR (–ª—É—á—à–µ Tesseract)<br>2. Fallback –Ω–∞ Azure OCR –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤<br>3. Quality warning –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **–í—ã—Å–æ–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å LLM** | Medium | Medium | 1. Cascading pipeline (Level 1‚Üí2‚Üí3)<br>2. LLM caching<br>3. Router –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏<br>4. Batch processing |
| **LayoutLM –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ CPU** | Low | High | 1. ONNX quantization<br>2. –£–ø—Ä–æ—Å—Ç–∏—Ç—å –º–æ–¥–µ–ª—å<br>3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å rule-based segmentation |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å legacy –∫–æ–¥–æ–º** | Medium | Medium | 1. Backward compatibility layer<br>2. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è<br>3. Feature flag (enable_idp) |
| **–ù–µ—Ö–≤–∞—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è** | Medium | Low | 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pre-trained –º–æ–¥–µ–ª–∏<br>2. Zero-shot/few-shot prompting<br>3. –°–æ–±–∏—Ä–∞—Ç—å feedback –¥–ª—è fine-tuning |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ë–î (JSONB)** | Low | Medium | 1. GIN –∏–Ω–¥–µ–∫—Å—ã<br>2. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü<br>3. Caching —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ |

---

## 13. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (Action Items)

### ‚úÖ –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (—ç—Ç–∞ –Ω–µ–¥–µ–ª—è)

1. **–û–±—Å—É–¥–∏—Ç—å –∫–æ–Ω—Ü–µ–ø—Ü–∏—é —Å –∫–æ–º–∞–Ω–¥–æ–π**
   - –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ meeting
   - –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ —é—Ä–∏—Å—Ç–æ–≤
   - –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

2. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostgreSQL 16+ (–µ—Å–ª–∏ –µ—â–µ SQLite)
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Redis (–¥–ª—è Celery)
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
     ```bash
     pip install paddlepaddle paddleocr onnxruntime transformers
     ```

3. **–°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**
   ```bash
   git checkout -b feature/idp-integration
   ```

4. **–ü—Ä–æ—Ç–æ—Ç–∏–ø –ë–î**
   - –°–æ–∑–¥–∞—Ç—å Alembic –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### üìù –†–µ—à–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å

| –í–æ–ø—Ä–æ—Å | –û–ø—Ü–∏–∏ | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|--------|-------|--------------|
| **–ö–∞–∫–æ–π OCR –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?** | Tesseract vs PaddleOCR vs Azure | PaddleOCR (better for tables) |
| **–ì–¥–µ —Ö–æ—Å—Ç–∏—Ç—å LayoutLM?** | Local CPU vs Cloud GPU | Local CPU —Å ONNX (MVP) |
| **LLM provider –¥–ª—è Level 2?** | OpenRouter vs DeepInfra vs Groq | OpenRouter (–≥–∏–±–∫–æ—Å—Ç—å) |
| **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö?** | SQLite vs PostgreSQL | PostgreSQL (–¥–ª—è production) |
| **Message broker?** | Redis+Celery vs RabbitMQ | Redis+Celery (–ø—Ä–æ—â–µ) |
| **Storage –¥–ª—è —Ñ–∞–π–ª–æ–≤?** | Local FS vs MinIO vs S3 | Local FS (MVP) ‚Üí MinIO |

### üéØ –¶–µ–ª—å –Ω–∞ 2 –º–µ—Å—è—Ü–∞

**–ö –∫–æ–Ω—Ü—É Phase 4 (8 –Ω–µ–¥–µ–ª—å):**
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞—é—â–∞—è IDP —Å–∏—Å—Ç–µ–º–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ XML, PDF, —Å–∫–∞–Ω–æ–≤
- ‚úÖ Cascading extraction (3 —É—Ä–æ–≤–Ω—è)
- ‚úÖ Hybrid Star Schema –≤ production –ë–î
- ‚úÖ API endpoints –≥–æ—Ç–æ–≤—ã
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –¥–∞—Ç–∞—Å–µ—Ç: 100 –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —é—Ä–∏—Å—Ç–æ–≤

---

## üìö –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### A. –ü—Ä–∏–º–µ—Ä—ã Intermediate JSON

```json
{
  "doc_number": "–î–ü-123/2024",
  "signed_date": "2024-01-15",
  "contract_type": "supply",
  "total_amount": 1500000.00,
  "currency": "RUB",

  "parties": [
    {
      "role": "seller",
      "name": "–û–û–û \"–ü–æ—Å—Ç–∞–≤—â–∏–∫\"",
      "inn": "7701234567",
      "ogrn": "1027700123456",
      "legal_address": "–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10",
      "bank_details": {
        "account": "40702810100000001234",
        "bank_name": "–ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫",
        "bik": "044525225",
        "correspondent_account": "30101810400000000225"
      }
    },
    {
      "role": "buyer",
      "name": "–ê–û \"–ü–æ–∫—É–ø–∞—Ç–µ–ª—å\"",
      "inn": "7702345678",
      ...
    }
  ],

  "items": [
    {
      "line_number": 1,
      "name": "–¢–æ–≤–∞—Ä –ê",
      "quantity": 100,
      "unit": "—à—Ç",
      "price": 10000.00,
      "total": 1000000.00,
      "sku": "SKU-001"
    },
    {
      "line_number": 2,
      "name": "–¢–æ–≤–∞—Ä –ë",
      "quantity": 50,
      "unit": "–∫–≥",
      "price": 10000.00,
      "total": 500000.00,
      "sku": "SKU-002"
    }
  ],

  "payment_schedule": [
    {
      "type": "prepayment",
      "percentage": 30,
      "amount": 450000.00,
      "condition": "–≤ —Ç–µ—á–µ–Ω–∏–µ 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π —Å –¥–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è",
      "days_offset": 5,
      "trigger": "contract_signing"
    },
    {
      "type": "postpayment",
      "percentage": 70,
      "amount": 1050000.00,
      "condition": "–≤ —Ç–µ—á–µ–Ω–∏–µ 10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –∞–∫—Ç–∞ –ø—Ä–∏–µ–º–∫–∏",
      "days_offset": 10,
      "trigger": "act_signing"
    }
  ],

  "rules": [
    {
      "rule_type": "penalty",
      "title": "–ù–µ—É—Å—Ç–æ–π–∫–∞ –∑–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É –ø–æ—Å—Ç–∞–≤–∫–∏",
      "trigger_condition": "delay_days > 0",
      "formula": {
        "type": "penalty",
        "rate": 0.001,
        "base": "outstanding_balance",
        "period": "daily",
        "cap": 0.10
      },
      "original_text": "–ó–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏ –ü–æ—Å—Ç–∞–≤—â–∏–∫ —É–ø–ª–∞—á–∏–≤–∞–µ—Ç –Ω–µ—É—Å—Ç–æ–π–∫—É –≤ —Ä–∞–∑–º–µ—Ä–µ 0,1% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–µ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏, –Ω–æ –Ω–µ –±–æ–ª–µ–µ 10% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä–∞.",
      "affected_party": "seller",
      "legal_basis": "—Å—Ç. 330 –ì–ö –†–§"
    },
    {
      "rule_type": "termination",
      "title": "–†–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ –ø—Ä–∏ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –ø—Ä–æ—Å—Ä–æ—á–∫–µ",
      "trigger_condition": "delay_days > 30",
      "formula": {
        "type": "termination",
        "notice_period_days": 10,
        "compensation": "return_prepayment"
      },
      "original_text": "–ü—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 30 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –≤–ø—Ä–∞–≤–µ –≤ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø–æ—Ä—è–¥–∫–µ —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç—å –î–æ–≥–æ–≤–æ—Ä, –Ω–∞–ø—Ä–∞–≤–∏–≤ –ø–∏—Å—å–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –ø–æ–∑–¥–Ω–µ–µ —á–µ–º –∑–∞ 10 –¥–Ω–µ–π.",
      "affected_party": "buyer",
      "legal_basis": "—Å—Ç. 450 –ì–ö –†–§"
    }
  ],

  "attributes": {
    "delivery_type": "–∞–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç",
    "delivery_address": "–≥. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, —É–ª. –ù–µ–≤—Å–∫–∏–π, –¥. 100",
    "delivery_period": "30 –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π",
    "warranty_period": "12 –º–µ—Å—è—Ü–µ–≤",
    "quality_certificate": "required",
    "project_manager": "–ò–≤–∞–Ω–æ–≤ –ò.–ò.",
    "special_conditions": [
      "–¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–æ–≤—ã–º, –±–µ–∑ —Å–ª–µ–¥–æ–≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏",
      "–£–ø–∞–∫–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞"
    ]
  }
}
```

### B. –ü—Ä–∏–º–µ—Ä SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Hybrid Schema

```sql
-- 1. –ù–∞–π—Ç–∏ –≤—Å–µ –¥–æ–≥–æ–≤–æ—Ä—ã —Å –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–æ–π > 50%
SELECT
    cc.id,
    cc.doc_number,
    cc.total_amount,
    ps.percentage as prepayment_pct
FROM contracts_core cc
JOIN payment_schedule ps ON ps.contract_id = cc.id
WHERE ps.payment_type = 'prepayment'
  AND ps.percentage > 50;

-- 2. –¢–æ–ø-10 –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –ø–æ –æ–±—ä–µ–º—É –¥–æ–≥–æ–≤–æ—Ä–æ–≤
SELECT
    cp.name,
    cp.tax_id,
    COUNT(*) as contract_count,
    SUM(cc.total_amount) as total_volume
FROM contract_parties cp
JOIN contracts_core cc ON cc.id = cp.contract_id
WHERE cp.role = 'seller'
  AND cc.status = 'active'
GROUP BY cp.name, cp.tax_id
ORDER BY total_volume DESC
LIMIT 10;

-- 3. –î–æ–≥–æ–≤–æ—Ä—ã —Å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º–∏ —à—Ç—Ä–∞—Ñ–∞–º–∏ (>0.5% –≤ –¥–µ–Ω—å)
SELECT
    cc.id,
    cc.doc_number,
    cr.rule_name,
    cr.formula->>'rate' as penalty_rate
FROM contracts_core cc
JOIN contract_rules cr ON cr.contract_id = cc.id
WHERE cr.section_type = 'penalty'
  AND (cr.formula->>'rate')::numeric > 0.005;

-- 4. –î–æ–≥–æ–≤–æ—Ä—ã —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –∞–≤–∏–∞—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º (–≥–∏–±–∫–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã)
SELECT
    id,
    doc_number,
    attributes->>'delivery_type' as delivery_type,
    attributes->>'delivery_address' as address
FROM contracts_core
WHERE attributes @> '{"delivery_type": "–∞–≤–∏–∞"}';

-- 5. –†–∞—Å—á–µ—Ç –æ–±—â–µ–≥–æ —Ä–∏—Å–∫–∞ –ø–æ –ø–æ—Ä—Ç—Ñ–µ–ª—é –¥–æ–≥–æ–≤–æ—Ä–æ–≤
WITH penalty_risks AS (
    SELECT
        cc.id,
        cc.doc_number,
        cc.total_amount,
        (cr.formula->>'rate')::numeric *
        EXTRACT(DAYS FROM (CURRENT_DATE - cc.signed_date))::numeric as potential_penalty
    FROM contracts_core cc
    JOIN contract_rules cr ON cr.contract_id = cc.id
    WHERE cr.section_type = 'penalty'
      AND cc.status = 'active'
)
SELECT
    SUM(potential_penalty) as total_risk_amount,
    COUNT(*) as contracts_at_risk
FROM penalty_risks
WHERE potential_penalty > 0;
```

### C. –ì–ª–æ—Å—Å–∞—Ä–∏–π

| –¢–µ—Ä–º–∏–Ω | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ |
|--------|-------------|
| **IDP** | Intelligent Document Processing - –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é AI |
| **Hybrid Star Schema** | –°—Ö–µ–º–∞ –ë–î, –∫–æ–º–±–∏–Ω–∏—Ä—É—é—â–∞—è –∂–µ—Å—Ç–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –∏ JSONB –¥–ª—è –≥–∏–±–∫–∏—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ |
| **Computable Contract** | –î–æ–≥–æ–≤–æ—Ä, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–∞–∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ + –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞ |
| **Cascading Extraction** | –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞: –ø—Ä–æ—Å—Ç—ã–µ –º–µ—Ç–æ–¥—ã (regex) ‚Üí LLM —Å—Ä–µ–¥–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Üí SOTA LLM |
| **Layout Analysis** | –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ (header, terms, tables, signatures) |
| **Intermediate JSON** | –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î |
| **GIN Index** | Generalized Inverted Index - –∏–Ω–¥–µ–∫—Å PostgreSQL –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ JSONB |
| **ONNX Runtime** | –ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–π runtime –¥–ª—è ML –º–æ–¥–µ–ª–µ–π (–ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ CPU) |
| **LayoutLMv3** | Microsoft –º–æ–¥–µ–ª—å –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ |
| **PaddleOCR** | OCR-—Å–∏—Å—Ç–µ–º–∞ –æ—Ç Baidu, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è —Ç–∞–±–ª–∏—Ü |

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –≤–æ–ø—Ä–æ—Å—ã

**–ê–≤—Ç–æ—Ä –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:** AI Assistant
**–î–∞—Ç–∞:** 2026-01-08
**–í–µ—Ä—Å–∏—è:** 1.0 (Draft for Discussion)

**–í–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è:**
1. –°–æ–≥–ª–∞—Å–Ω—ã –ª–∏ —Å–æ Hybrid Star Schema –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é JSONB?
2. –ö–∞–∫–æ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ñ–∞–∑ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è? (–ú–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å Phase 4 —Ä–∞–Ω—å—à–µ Phase 3)
3. Budget –Ω–∞ LLM API? (–≤–ª–∏—è–µ—Ç –Ω–∞ –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–µ–π)
4. –ï—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –∫ —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è?
5. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏? (–≤–ª–∏—è–µ—Ç –Ω–∞ CPU vs GPU)

---

**–°–¢–ê–¢–£–°:** üìã –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é
**–°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì:** –û–±—Å—É–∂–¥–µ–Ω–∏–µ –∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞ ‚Üí –ù–∞—á–∞–ª–æ Phase 1
